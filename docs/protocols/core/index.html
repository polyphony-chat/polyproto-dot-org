<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-protocols/core" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">polyproto Core Protocol Specification | polyproto</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://polyproto.org/img/banner-social.jpg"><meta data-rh="true" name="twitter:image" content="https://polyproto.org/img/banner-social.jpg"><meta data-rh="true" property="og:url" content="https://polyproto.org/docs/protocols/core"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="polyproto Core Protocol Specification | polyproto"><meta data-rh="true" name="description" content="The core protocol specification. Read this first!"><meta data-rh="true" property="og:description" content="The core protocol specification. Read this first!"><link data-rh="true" rel="icon" href="/img/logo.svg"><link data-rh="true" rel="canonical" href="https://polyproto.org/docs/protocols/core"><link data-rh="true" rel="alternate" href="https://polyproto.org/docs/protocols/core" hreflang="en"><link data-rh="true" rel="alternate" href="https://polyproto.org/docs/protocols/core" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Protocol Definitions","item":"https://polyproto.org/docs/category/protocol-definitions"},{"@type":"ListItem","position":2,"name":"polyproto Core Protocol Specification","item":"https://polyproto.org/docs/protocols/core"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="polyproto RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="polyproto Atom Feed">






<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.8872d65e.css">
<script src="/assets/js/runtime~main.c4a408e5.js" defer="defer"></script>
<script src="/assets/js/main.5f77d254.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar bg-black h-16 navbar--fixed-top"><div class="navbar__inner max-w-7xl mx-auto text-xl"><div class="navbar__items"><a class="navbar__brand text-white no-underline" href="/"><div class="navbar__logo size-10"><img src="/img/logo.svg" alt="polyproto Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="polyproto Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">polyproto</b></a></div><div class="navbar__items navbar__items--right"><a href="/docs/intro" class="border border-poly-green-1 bg-poly-black px-4 py-2 text-poly-green-1 rounded-md text-center hover:no-underline hover:text-poly-green-1 flex justify-center items-center px-6 !py-1 text-base no-underline anchor-shadow transition ease-in-out duration-300">Docs</a><a href="/blog/" class="border border-poly-green-1 bg-poly-black px-4 py-2 text-poly-green-1 rounded-md text-center hover:no-underline hover:text-poly-green-1 flex justify-center items-center px-6 !py-1 mx-4 text-base no-underline anchor-shadow transition ease-in-out duration-300">Blog</a><div class="navbarSearchContainer_dCNk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">An Overview of polyproto</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/protocol-definitions">Protocol Definitions</a><button aria-label="Collapse sidebar category &#x27;Protocol Definitions&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/protocols/core">polyproto Core Protocol Specification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/protocols/auth">polyproto-auth Extension Specification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/protocols/chat">polyproto-chat Extension Specification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/protocols/mls">polyproto-mls Extension Specification</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/contribute">How and what to contribute</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/docs/category/protocol-definitions"><span>Protocol Definitions</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">polyproto Core Protocol Specification</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>polyproto Specification</h1></header>
<p><strong>Namespace:</strong> <code>core</code></p>
<p><strong>Version:</strong> <code>v1.0-alpha.1</code></p>
<p><strong>Base Path:</strong> <code>/.p2/core/v1/</code></p>
<p><strong>API documentation:</strong> <a href="https://apidocs.polyproto.org" target="_blank" rel="noopener noreferrer">apidocs.polyproto.org</a></p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>The polyproto specification document is in an <strong>alpha</strong> phase. Please report any inconsistencies,
missing or duplicate information and other mistakes at <a href="https://github.com/polyphony-chat/docs/issues" target="_blank" rel="noopener noreferrer">github.com/polyphony-chat/docs/issues</a>.</p></div></div>
<p><a href="https://semver.org/spec/v2.0.0.html" target="_blank" rel="noopener noreferrer">Semantic versioning v2.0.0</a> is used to version this specification.</p>
<p>The polyproto protocol is a home-server-based identity federation protocol specification intended
for use in applications where actor identity is needed. polyproto focuses on federated identity
and does not specify any further application-specific features. It can be used standalone, as a
method of authenticating across many applications and services, or as a base for federated protocol
extensions and application implementations. The use of cryptography—namely digital
signatures and X.509 certificates—make polyproto identities verifiable and portable. polyproto
empowers actors, as the home server can be changed at any time, without losing data or connections
to other actors.</p>
<p>This document is intended to be used as a starting point for developers wanting to develop software
that can operate with other polyproto implementations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-terminology-used-in-this-document">1. Terminology used in this document<a href="#1-terminology-used-in-this-document" class="hash-link" aria-label="Direct link to 1. Terminology used in this document" title="Direct link to 1. Terminology used in this document">​</a></h2>
<p>The following terminology is used throughout this document:</p>
<p>TODO: glossary is missing</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-trust-model">2. Trust model<a href="#2-trust-model" class="hash-link" aria-label="Direct link to 2. Trust model" title="Direct link to 2. Trust model">​</a></h2>
<p>polyproto operates under the following trust assumptions:</p>
<ol>
<li>Users entrust their home server and its admins with data security and discretion on actions
appearing as actor-performed, as, with most home server-based systems, it is
possible for a home server to impersonate an actor in unencrypted communications.</li>
<li>Impersonation <em>can</em> be detected by users, as home servers never have access to private keys of
actors. To sign messages as an actor, a home server would have to use a different key pair.</li>
<li>Users only trust information that can be verified by cryptographic means. This includes
verifying the identity of other actors and verifying the integrity of messages.</li>
<li>In a federated context, users trust foreign servers with all unencrypted data they send
to them.</li>
<li>Foreign servers cannot impersonate users without immediate detection. Outsiders, meaning foreign
servers and other actors, are unable to produce signatures that have a cryptographic connection
to the actors&#x27; home server. This is assuming correct implementation of cryptographic
standards, secure home server operation, and non-compromised client devices, all of which are
mostly out of the scope of this specification.</li>
<li>Users rely on their home server for identity key certification, without the home server
possessing the identity.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-apis-and-underlying-communication-protocols">3. APIs and underlying communication protocols<a href="#3-apis-and-underlying-communication-protocols" class="hash-link" aria-label="Direct link to 3. APIs and underlying communication protocols" title="Direct link to 3. APIs and underlying communication protocols">​</a></h2>
<p>The polyproto specification defines a set of <a href="https://apidocs.polyproto.org" target="_blank" rel="noopener noreferrer">APIs</a>.
In addition to these REST APIs, polyproto employs WebSockets for real-time communication between
clients and servers.</p>
<p>The APIs are divided into two categories:</p>
<ul>
<li><strong>Routes: No registration needed</strong>: These routes are available to all clients, regardless of
whether this server is the client&#x27;s home server.</li>
<li><strong>Routes: Registration needed</strong>: These routes are only available to clients where the server is
the client&#x27;s home server.</li>
</ul>
<p>All software aiming to federate with other polyproto implementations must implement the APIs defined
in the <a href="https://apidocs.polyproto.org" target="_blank" rel="noopener noreferrer">API specification</a>. Implementations can choose to extend the
APIs with additional routes but must not remove or change the behavior of the routes defined in
this specification.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-well-known">3.1 <code>.well-known</code><a href="#31-well-known" class="hash-link" aria-label="Direct link to 31-well-known" title="Direct link to 31-well-known">​</a></h3>
<p><code>/.well-known/</code> locations facilitate the discovery of resources and services available on a given
host.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Consult the excerpt of this specification explaining what a &quot;domain name&quot; is, to avoid
misunderstandings. You can find this excerpt <a href="#def-domain-name">here</a>.</p></div></div>
<p>polyproto servers can be hosted under a domain name different from the domain name
appearing on ID-Certs managed by that server <strong>if all the following conditions are met:</strong></p>
<ol>
<li>
<p>Define the &quot;<em>visible domain name</em>&quot; as the domain name described by the <a href="#6111-polyproto-distinguished-name-pdn">polyproto distinguished name</a>
of the &quot;issuer&quot; field on an ID-Cert.</p>
</li>
<li>
<p>Define the &quot;<em>actual domain name</em>&quot; as the domain name where the polyproto server is actually hosted
under.</p>
</li>
<li>
<p>The <em>visible domain name</em> <strong>must</strong> have a URI <code>[visible domain name]/.well-known/polyproto-core</code>,
accessible via an HTTP GET request.</p>
</li>
<li>
<p>The resource accessible at this URI must be a JSON object formatted as such:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;api&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[actual domain name]/.p2/core/&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
</li>
<li>
<p>The ID-Cert received when querying <code>[actual domain name]/.p2/core/idcert/server</code> with an HTTP GET
request must have a field &quot;issuer&quot; containing domain components (<code>dc</code>) that, when parsed, <strong>equal</strong>
the domain name of the <em>visible domain name</em>. If the domain components in this field do not match
the domain components of the <em>visible domain name</em>, the server hosted under the <em>actual domain name</em>
must not be treated as a polyproto server for the <em>visible domain name</em>.</p>
</li>
</ol>
<p>Every polyproto home server must have a <code>.well-known</code> URI, accessible via an HTTP GET request.</p>
<p>Should a client not be able to access the polyproto API endpoints located at <code>[visible domain name]/.p2/core/</code>,
the client must query <code>[visible domain name]/.well-known/polyproto-core</code> with an HTTP GET request and
try to verify the above-mentioned conditions. If all the above-mentioned conditions can be fulfilled,
the client can treat the server located at the <em>actual domain name</em> as a polyproto server serving the
<em>visible domain name</em>. Clients must not treat the server located at the <em>actual domain name</em> as a
polyproto server serving the <em>actual domain name</em>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-websocket-protocol">3.2 WebSocket Protocol<a href="#32-websocket-protocol" class="hash-link" aria-label="Direct link to 3.2 WebSocket Protocol" title="Direct link to 3.2 WebSocket Protocol">​</a></h3>
<p>WebSockets enable real-time, bidirectional communication between actor clients and home servers.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>A polyproto WebSocket server is also called &quot;Gateway&quot; or &quot;Gateway Server&quot; for short.</p></div></div>
<p>WebSocket connections to polyproto servers consist of the following, general cycle:</p>
<!-- -->
<p><em>Fig. 1: Sequence diagram of a WebSocket connection to a polyproto server.</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="321-gateway-event-payloads">3.2.1 Gateway Event Payloads<a href="#321-gateway-event-payloads" class="hash-link" aria-label="Direct link to 3.2.1 Gateway Event Payloads" title="Direct link to 3.2.1 Gateway Event Payloads">​</a></h4>
<p>Gateway event payloads share a general structure, though the content of the <code>d</code> field varies depending
on the specific event.</p>
<table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>n</code></td><td>string</td><td><a href="#82-namespaces">Namespace</a> context for this payload.</td></tr><tr><td><code>op</code></td><td>uint16</td><td>Gateway Opcode indicating the type of payload.</td></tr><tr><td><code>d</code></td><td>JSON value</td><td>The event data associated with this payload.</td></tr><tr><td><code>s</code>¹</td><td>uint64</td><td>Sequence number of the event, used for guaranteed, ordered delivery</td></tr></tbody></table>
<p>¹: This field is only received by clients and never sent to the server.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3211-namespaces-n">3.2.1.1 Namespaces <code>n</code><a href="#3211-namespaces-n" class="hash-link" aria-label="Direct link to 3211-namespaces-n" title="Direct link to 3211-namespaces-n">​</a></h5>
<p>The <code>n</code> field in a gateway event payload indicates the namespace context for the payload. You can
read more about namespaces in <a href="#82-namespaces">section 8.2</a>.
messages
Every namespace may define its own set of opcodes and event names.</p>
<p>The namespace context must be known to the entity receiving the payload, as it is crucial for
correctly interpreting the payload.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3212-opcodes-op">3.2.1.2 Opcodes <code>op</code><a href="#3212-opcodes-op" class="hash-link" aria-label="Direct link to 3212-opcodes-op" title="Direct link to 3212-opcodes-op">​</a></h5>
<p>The following opcodes are defined by the <code>core</code> namespace:</p>
<table><thead><tr><th>Opcode</th><th>Name</th><th>Action</th><th>Description</th></tr></thead><tbody><tr><td><code>0</code></td><td>Heartbeat</td><td>Actor Send</td><td>Keep alive for the WebSocket session.</td></tr><tr><td><code>1</code></td><td>Hello</td><td>Actor Receive</td><td>Received upon establishing a connection.</td></tr><tr><td><code>2</code></td><td>Identify</td><td>Actor Send</td><td>Identify to the server.</td></tr><tr><td><code>3</code></td><td>New Session</td><td>Actor Receive</td><td>Received by all sessions except the new one.</td></tr><tr><td><code>4</code></td><td>Actor Certificate Invalidation</td><td>Actor Send/Receive</td><td>An actor certificate has been invalidated. Sent <em>to</em> server when an actor invalidates one of their certificates.</td></tr><tr><td><code>5</code></td><td>Resume</td><td>Actor Send</td><td>Request the replaying events after re-connecting.</td></tr><tr><td><code>6</code></td><td>Server Certificate Change</td><td>Actor Receive</td><td>Received when the server&#x27;s certificate changed.</td></tr><tr><td><code>7</code></td><td>Heartbeat ACK</td><td>Actor Receive</td><td>Acknowledgement of a heartbeat</td></tr><tr><td><code>8</code></td><td>Service Channel</td><td>Actor Send/Receive</td><td>Open or close a service channel.</td></tr><tr><td><code>9</code></td><td>Service Channel ACK</td><td>Actor Receive</td><td>Acknowledgement of a service channel event.</td></tr><tr><td><code>10</code></td><td>Resumed</td><td>Actor Receive</td><td>Replayed events.</td></tr><tr><td><code>11</code></td><td>Heartbeat Request</td><td>Actor Receive</td><td>The server requests a heartbeat from the client ASAP.</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3213-sequence-numbers-s">3.2.1.3 Sequence numbers <code>s</code><a href="#3213-sequence-numbers-s" class="hash-link" aria-label="Direct link to 3213-sequence-numbers-s" title="Direct link to 3213-sequence-numbers-s">​</a></h5>
<p>Sequence numbers are unsigned integers with a 64 bit length. In the rare event that this integer should
overflow, the server must close the connection to the client and prompt the client to initiate a new,
non-resumed gateway connection.</p>
<p>The sequence number increases by one for every gateway message sent by the server. The client must
keep track of received sequence numbers as part as the <a href="#326-guaranteed-delivery-of-gateway-messages-through-package-acknowledgement">guaranteed delivery mechanism</a>.
Every gateway connection has its own sequence number counter, starting at 0 for the first event sent
by the server.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="322-heartbeats">3.2.2 Heartbeats<a href="#322-heartbeats" class="hash-link" aria-label="Direct link to 3.2.2 Heartbeats" title="Direct link to 3.2.2 Heartbeats">​</a></h4>
<p>Heartbeats are used to keep the WebSocket connection alive and, combined with <a href="#3213-sequence-numbers-s">sequence numbers</a>,
form an application-layer packet acknowledgement mechanism. The client continuously sends a heartbeat
event to the server with the interval specified in the <a href="#3231-hello-event">&quot;Hello&quot; event payload</a>.
The server must acknowledge the heartbeat event by sending a heartbeat ACK event back to the client.</p>
<p>Servers must account for the time it takes for the client to send the heartbeat event.</p>
<p>Before closing a connection due to a missed heartbeat, the server should request a heartbeat event
from the client by sending a heartbeat request event to the client. If the client is not responding within
a reasonable time frame, the server should close the gateway connection with an appropriate
<a href="#325-closing-a-connection">close code</a>.</p>
<p>The structure of the heartbeat and heartbeat ACK events are described in <a href="#3238-heartbeat-and-heartbeat-ack-events">section 3.2.3.8</a>.</p>
<p>Recommended values for heartbeat intervals are 30 to 60 seconds. The heartbeat interval is chosen by
the server.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="323-gateway-event-payload-definitions">3.2.3 Gateway event payload definitions<a href="#323-gateway-event-payload-definitions" class="hash-link" aria-label="Direct link to 3.2.3 Gateway event payload definitions" title="Direct link to 3.2.3 Gateway event payload definitions">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3231-hello-event">3.2.3.1 &quot;Hello&quot; event<a href="#3231-hello-event" class="hash-link" aria-label="Direct link to 3.2.3.1 &quot;Hello&quot; event" title="Direct link to 3.2.3.1 &quot;Hello&quot; event">​</a></h5>
<p>The &quot;Hello&quot; event is sent by the server to the client upon establishing a connection. The <code>d</code> payload
for a &quot;Hello&quot; event is an object containing a <code>heartbeat_interval</code> field, which specifies the interval
in milliseconds at which the client should send heartbeat events to the server.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example hello event payload</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;heartbeat_interval&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">45000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;s&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>heartbeat_interval</code></td><td>uint32</td><td>Interval in milliseconds at which the client should send heartbeat events to the server.</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3232-identify-event">3.2.3.2 Identify event<a href="#3232-identify-event" class="hash-link" aria-label="Direct link to 3.2.3.2 Identify event" title="Direct link to 3.2.3.2 Identify event">​</a></h5>
<p>The &quot;identify&quot; event is sent by the client to the server to let the server know which actor the
client is.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example identify event payload</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;a9144379a161e1fcf6b07801b70db6d6c481...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>token</code></td><td>string</td><td>A <a href="#41-authentication">session token</a> issued by the server, identifying the session the client wants to connect with.</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This event may be extended in a backwards-compatible manner in future versions of polyproto.</p></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3233-service-channels">3.2.3.3 Service channels<a href="#3233-service-channels" class="hash-link" aria-label="Direct link to 3.2.3.3 Service channels" title="Direct link to 3.2.3.3 Service channels">​</a></h5>
<p>Service channels act like topics in a pub/sub system. They allow clients to subscribe to a specific
topic and receive messages sent to that topic.</p>
<p>Converting that analogy to polyproto, service channels allow clients to subscribe to gateway events
of additional namespaces. Service channels allow a unified way of giving extensions access to WebSockets
without having to initialize a separate WebSocket connection.</p>
<p>A service channel event payload has the following structure:</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example service channel event payload</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;action&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;subscribe&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;service&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;service_name&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>action</code></td><td>string</td><td>The action to perform on the service channel. Must be either <code>subscribe</code> or <code>unsubscribe</code>.</td></tr><tr><td><code>service</code></td><td>string</td><td>The name of a polyproto service.</td></tr></tbody></table>
<p>The server must respond with a <code>Service Channel ACK</code> event payload, indicating whether the action
was successful or not. Clients should expect that the server sends a <code>Service Channel</code> payload indicating
the closing of a channel.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example service channel ACK event payload - failure</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;action&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;subscribe&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;service&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;service_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;success&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;error&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Service not found&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property" style="color:#36acaa">&quot;s&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example service channel ACK event payload - success</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;action&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;subscribe&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;service&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;service_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;success&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;s&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>action</code></td><td>string</td><td>The action to perform on the service channel. Must be either <code>subscribe</code> or <code>unsubscribe</code>.</td></tr><tr><td><code>service</code></td><td>string</td><td>The polyproto service that was specified in the opcode 8 request</td></tr><tr><td><code>success</code></td><td>boolean</td><td>Whether the action was successful or not.</td></tr><tr><td><code>error</code></td><td>string?</td><td>Only present if <code>success</code> is <code>false</code>. A message indicating why the action failed.</td></tr></tbody></table>
<p>If a successful subscription to a service channel is acknowledged, all logic and further event on
this channel are defined by the service&#x27;s specification.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3234-new-session-event">3.2.3.4 New session event<a href="#3234-new-session-event" class="hash-link" aria-label="Direct link to 3.2.3.4 New session event" title="Direct link to 3.2.3.4 New session event">​</a></h5>
<p>The &quot;New Session&quot; event is sent by the server to all sessions except the new one. The <code>d</code> payload
of this event contains the ASCII-PEM encoded ID-Cert of the new session. You can find more information
about the new session mechanism in <a href="#43-protection-against-misuse-by-malicious-home-servers">section 4.3</a>.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example new session event payload</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;cert&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-----BEGIN CERTIFICATE-----\nMIIBIjANB...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;s&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>cert</code></td><td>string</td><td>ASCII-PEM encoded ID-Cert of the new session.</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3235-actor-certificate-invalidation-event">3.2.3.5 Actor certificate invalidation event<a href="#3235-actor-certificate-invalidation-event" class="hash-link" aria-label="Direct link to 3.2.3.5 Actor certificate invalidation event" title="Direct link to 3.2.3.5 Actor certificate invalidation event">​</a></h5>
<p>The actor certificate invalidation event is crucial to ensure that the client can detect and respond
to changes in actor certificates. This prevents clients and servers from accepting outdated ID-Certs.
This event is only sent by servers if an <a href="#614-early-revocation-of-id-certs">early revocation of an actor ID-Cert</a>
occurs.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example actor certificate invalidation event payload</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;serial&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;11704583652649&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;invalidSince&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1737379403&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;signature&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;8eacd92192bacc57bb5df3c7922e93bbc8b3f683f5dec9224353b102fa2f2a75&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;s&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>serial</code></td><td>uint64</td><td>The serial number of the invalidated ID-Cert</td></tr><tr><td><code>invalidSince</code></td><td>uint64</td><td>UNIX timestamp of the point in time where this ID-Cert became invalid on</td></tr><tr><td><code>signature</code></td><td>string</td><td>Signature of a string concatenation of the <code>invalidSince</code> timestamp and the <code>serial</code> number, in that order. Clients must verify this signature, verifying that the signature was generated by the private key of the revoked certificate.</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3236-resume-event-and-resumed-event">3.2.3.6 &quot;Resume&quot; event and &quot;resumed&quot; event<a href="#3236-resume-event-and-resumed-event" class="hash-link" aria-label="Direct link to 3.2.3.6 &quot;Resume&quot; event and &quot;resumed&quot; event" title="Direct link to 3.2.3.6 &quot;Resume&quot; event and &quot;resumed&quot; event">​</a></h5>
<p>When a client re-connects to a polyproto WebSocket gateway server, the client may send a resume event
to the server instead of identifying. The resumed event sent by the server informs the client
about everything the client has missed since their last active connection to the gateway.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example resume event structure</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;s&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;aDHsdfghihn2n0c634tnlxibnd2tz09y8m7kbxti7rg&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>s</code></td><td>uint64</td><td>Sequence number of the last event received by the client; aka. &quot;Where to receive from&quot;.</td></tr><tr><td><code>token</code></td><td>string</td><td>A <a href="#41-authentication">session token</a> issued by the server, identifying the session the client wants to connect with.</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example &quot;resumed&quot; event</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;payload data&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<p>As touched on earlier, the &quot;resumed&quot; event contains all relevant events the client has missed.</p>
<p>&quot;Missed events&quot; are events with</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>s</mi><mrow><mi>e</mi><mi>v</mi><mi>e</mi><mi>n</mi><mi>t</mi></mrow></msub><mo>&gt;</mo><msub><mi>s</mi><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>m</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">s_{event} \gt s_{resume}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.03588em">v</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">n</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">res</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span>
<p>where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>u</mi><mi>m</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">s_{resume}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">res</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> is equal to the parameter <code>s</code> supplied by the client in the resume event.</p>
<p>A set of &quot;relevant events&quot; is a set of events which meet both of the following conditions:</p>
<ol>
<li>Each event in the set is intended to be received by the client</li>
<li>The set must contain the lowest possible amount of events necessary for the client to be informed
about everything that happened while they were disconnected.</li>
</ol>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example for condition #2</div><div class="admonitionContent_BuS1"><p>Assume, that an event &quot;total number of messages sent&quot; exists. The value of this event
payload is a number, representing the total number of messages sent on the entire server. Under
normal circumstances, each client receives this imaginary event every time this state changes.</p><p>For the client to resume, the server should not send each individual update of this value to the
client as part of the &quot;resumed&quot; event. Instead, it would be sufficient to send the most
up-to-date value of this event as part of the &quot;resumed&quot; payload, since how many times this event
has been fired and what previous values of this event were, has no impact
on the validity or state of other events.</p><p>Certificate change events are an example of events, where all intermediary values of the event
are important as well. This is because a client could have sent a message where the signature was
generated using a revoked certificate. In other words, intermediary values of this event type
affect the validity or state of other events.</p></div></div>
<p>Servers may reject a clients&#x27; wish to resume, if</p>
<ul>
<li>The number of events that would need to be replayed is too high for the server to process.</li>
<li>The client is not eligible to resume and must start a new session instead.</li>
</ul>
<p>In this case, the request to resume is met with an appropriate <a href="#325-closing-a-connection">close code</a>
(ex.: <code>4010</code>) by the server and the connection is terminated.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3237-server-certificate-change-event">3.2.3.7 Server certificate change event<a href="#3237-server-certificate-change-event" class="hash-link" aria-label="Direct link to 3.2.3.7 Server certificate change event" title="Direct link to 3.2.3.7 Server certificate change event">​</a></h5>
<p>The server certificate change event notifies clients about a new server ID-Cert. The <code>d</code> payload
of this event contains the ASCII-PEM encoded ID-Cert of the server.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example server certificate change event payload</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;cert&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-----BEGIN CERTIFICATE-----\nMIIBIjANB...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;oldInvalidSince&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1630012713</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;s&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>cert</code></td><td>string</td><td>ASCII-PEM encoded server ID-Cert. The server ID-Cert is self-signed.</td></tr><tr><td><code>oldInvalidSince</code></td><td>uint64</td><td>A UNIX timestamp indicating when the old server ID-Cert became invalid.</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3238-heartbeat-and-heartbeat-ack-events">3.2.3.8 Heartbeat and heartbeat ACK events<a href="#3238-heartbeat-and-heartbeat-ack-events" class="hash-link" aria-label="Direct link to 3.2.3.8 Heartbeat and heartbeat ACK events" title="Direct link to 3.2.3.8 Heartbeat and heartbeat ACK events">​</a></h5>
<p>The heartbeat event is sent by the client to the server to keep the WebSocket connection alive.
The payload for the heartbeat event is a minified number list. Minified number lists are a JSON
object with the fields <code>from</code>, <code>to</code>, and <code>except</code>. The <code>from</code> and <code>to</code> fields are strings representing
a range of numbers. The <code>except</code> field is an array of strings representing numbers that are not
included in the range.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Numbers are formatted as strings due to JSON conventions. Every number in the <code>from</code>, <code>to</code> and
<code>except</code> fields is a valid, unsigned integer of up to 64 bits.</p></div></div>
<p>The range described by the <code>from</code> and <code>to</code> fields is a mathematical, closed interval, where
<code>from</code> is equal to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">a</span></span></span></span> and <code>to</code> is equal to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">b</span></span></span></span> :</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">[</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">]</mo><mo>=</mo><mo stretchy="false">{</mo><mi>x</mi><mo>∈</mo><mi mathvariant="double-struck">N</mi><mo>∣</mo><mi>a</mi><mo>≤</mo><mi>x</mi><mo>≤</mo><mi>b</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">[a,b]=\{x\in \mathbb {N} \mid a\leq x\leq b\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">[</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">b</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">{</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathbb">N</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">b</span><span class="mclose">}</span></span></span></span></span>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Minified number list</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    to</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;20&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    except</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;9&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;12&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;13&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>from</code></td><td>string</td><td>The lowest sequence number received this heartbeat interval</td></tr><tr><td><code>to</code></td><td>string</td><td>The highest sequence number received this heartbeat interval</td></tr><tr><td><code>except</code></td><td>array[string]?</td><td>Sequence numbers <code>x</code>, where {<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>∈</mo><mi mathvariant="double-struck">N</mi><mo>∣</mo><mi>f</mi><mi>r</mi><mi>o</mi><mi>m</mi><mo>≤</mo><mi>x</mi><mo>≤</mo><mi>t</mi><mi>o</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">x \in \mathbb{N} \mid from\leq x\leq to\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathbb">N</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mclose">}</span></span></span></span>, that were not received this heartbeat interval.</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example heartbeat event payload</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;from&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;213&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;to&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;219&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;except&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;214&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;216&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;s&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<p>A heartbeat ACK contains events that the client has re-requested as part of their heartbeat message.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example heartbeat ACK event payload</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;payload data&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;s&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<p>As such, the field <code>d</code> in a heartbeat ack may be empty, but never not present. The <code>d</code> field contains
an array of other gateway events. Heartbeat ACK payloads must not be present in this array, making recursion
impossible.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="3239-heartbeat-request">3.2.3.9 Heartbeat request<a href="#3239-heartbeat-request" class="hash-link" aria-label="Direct link to 3.2.3.9 Heartbeat request" title="Direct link to 3.2.3.9 Heartbeat request">​</a></h5>
<p>The server may manually request a heartbeat from a client at any time.
A heartbeat is usually manually requested, if the server has not received a heartbeat from the client
in due time. Clients should keep their &quot;heartbeat timer&quot; running as is after sending a heartbeat following
a heartbeat request.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>If the client heartbeat timer states that the next heartbeat in a heartbeat interval of 45 seconds
is due in 8 seconds, the timer should still &quot;read&quot; ~8 seconds after a manual heartbeat request
has been fulfilled. Of course, the client should not send the same heartbeat twice.</p></div></div>
<p>Heartbeat request events do not carry any data in their <code>d</code> payload.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example heartbeat request event payload</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;core&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;op&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;d&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;s&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="324-establishing-a-connection">3.2.4 Establishing a connection<a href="#324-establishing-a-connection" class="hash-link" aria-label="Direct link to 3.2.4 Establishing a connection" title="Direct link to 3.2.4 Establishing a connection">​</a></h4>
<p>TODO</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="325-closing-a-connection">3.2.5 Closing a connection<a href="#325-closing-a-connection" class="hash-link" aria-label="Direct link to 3.2.5 Closing a connection" title="Direct link to 3.2.5 Closing a connection">​</a></h4>
<p>At any time during the connection, the server or client may wish to terminate the session in an
orderly fashion. This is being done by sending a <a href="https://www.rfc-editor.org/rfc/rfc6455.html#section-7.1.5" target="_blank" rel="noopener noreferrer">WebSocket close code</a>
to the recipient. In addition to the pre-defined status codes in <a href="https://www.rfc-editor.org/rfc/rfc6455.html" target="_blank" rel="noopener noreferrer">IETF RFC #6455</a>,
polyproto servers and clients must know of and use the following status codes in their appropriate
situations:</p>
<table><thead><tr><th>Code</th><th>Description</th><th>Explanation</th><th>Eligible for <code>RESUME</code>?</th><th>Sent by server?</th><th>Sent by client?</th></tr></thead><tbody><tr><td><code>4000</code></td><td>Unknown error</td><td>An unknown error has occurred and the connection was terminated.</td><td>x</td><td>x</td><td>x</td></tr><tr><td><code>4001</code></td><td>Unknown opcode</td><td>The client has sent a message with an unknown <a href="#3212-opcodes-op">opcode</a> to the server.</td><td>x</td><td>x</td><td></td></tr><tr><td><code>4002</code></td><td>Invalid payload</td><td>The client has sent a message with an invalid payload to the server.</td><td>x</td><td>x</td><td></td></tr><tr><td><code>4003</code></td><td>Not authenticated</td><td>The server has received a message from the client before the client identified itself, or the clients&#x27; session has been invalidated.</td><td></td><td>x</td><td></td></tr><tr><td><code>4004</code></td><td>Invalid authentication</td><td>The authentication token received by the server as part of the identify payload is invalid.</td><td></td><td>x</td><td></td></tr><tr><td><code>4005</code></td><td>Already authenticated</td><td>The client has sent an identify payload even though it has already identified successfully.</td><td></td><td>x</td><td></td></tr><tr><td><code>4006</code></td><td>Reserved</td><td>4006 is a reserved value and has no function in polyproto v1.0. The specific meaning may be defined in the future.</td><td></td><td></td><td></td></tr><tr><td><code>4007</code></td><td>Invalid sequence number(s)</td><td>The client has sent a heartbeat containing sequence numbers that were invalid.</td><td>x</td><td>x</td><td></td></tr><tr><td><code>4008</code></td><td>Rate limited</td><td>The client has sent payloads too quickly.</td><td></td><td>x</td><td></td></tr><tr><td><code>4009</code></td><td>Timeout</td><td>The session has been deemed to be timed out. This can happen if a heartbeat or heartbeat ACK has not been sent in due time.</td><td>x (If sent by server)</td><td>x</td><td>x</td></tr><tr><td><code>4010</code></td><td>Unresumeable</td><td>The server has determined that this session cannot be resumed. The client should initiate a new, fresh connection to the gateway instead.</td><td></td><td>x</td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="326-guaranteed-delivery-of-gateway-messages-through-package-acknowledgement">3.2.6 Guaranteed delivery of gateway messages through package acknowledgement<a href="#326-guaranteed-delivery-of-gateway-messages-through-package-acknowledgement" class="hash-link" aria-label="Direct link to 3.2.6 Guaranteed delivery of gateway messages through package acknowledgement" title="Direct link to 3.2.6 Guaranteed delivery of gateway messages through package acknowledgement">​</a></h4>
<p>polyproto implements an application-level guaranteed delivery mechanism. This ensures that all gateway
messages sent from a home server to a client are received by the client in the order they were sent
in – especially when network conditions are suboptimal. This mechanism is based on the use of
<a href="#3213-sequence-numbers-s">sequence numbers</a> and <a href="#322-heartbeats">heartbeats</a>.</p>
<p>??? question &quot;Doesn&#x27;t TCP already cover this?&quot;</p>
<p>While TCP ensures reliable delivery of data during an active connection, it does not retain
knowledge of application-layer messages if a disconnect occurs. In such cases, the application
must implement its own mechanisms to track which messages were successfully received.</p>
<p>Application-layer acknowledgements allow the protocol to recover from interruptions by
identifying any messages that were lost during the disconnect and ensuring they are
retransmitted, preserving the integrity and completeness of communication between the client
and server.</p>
<p>The <a href="#3238-heartbeat-and-heartbeat-ack-events">heartbeat payload</a> defines a payload parameter <code>except</code>.</p>
<p>If <code>except</code> was present and contained entries in the heartbeat payload sent by a client, the server
must re-send these events in the <code>d</code> part of the heartbeat ACK response. How this <code>d</code> payload is to be
formatted is also defined in <a href="#3238-heartbeat-and-heartbeat-ack-events">section 3.2.3.8</a>.</p>
<p>The server must prioritize sending these &quot;missed&quot; events over other events. The server should expect
that a client requests these events yet another time.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="33-events-over-events">3.3 Events over events<a href="#33-events-over-events" class="hash-link" aria-label="Direct link to 3.3 Events over events" title="Direct link to 3.3 Events over events">​</a></h4>
<p>For some implementation contexts, a constant WebSocket connection might not be wanted. A client can
instead opt to query an API endpoint to receive events, which would normally be sent through the WebSocket
connection. Concrete polyproto implementations and extensions can decide whether this alternative
behavior is supported.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example</div><div class="admonitionContent_BuS1"><p>An example of an implementation context where having a constant WebSocket might not be wanted would
be Urban IoT devices, or devices with a limited or only periodically available internet
connection.</p></div></div>
<p>Querying [this endpoint](/APIs/Core/Routes%3A No registration needed/#get-events) yields a JSON array
containing all events the session has missed since last querying the endpoint or since last being
connected to the WebSocket.</p>
<p>Depending on how many events the session has
missed, the earliest events might be excluded from the response to limit the response body&#x27;s size. This
behavior should be explicitly documented in implementations or extensions of polyproto.</p>
<p>Due to the intended use cases for retrieving events through REST rather than WebSockets,
this endpoint is not a long-polling endpoint.</p>
<p>There are three intended, main modes for retrieving events in polyproto</p>
<ol>
<li>Keep a constant WebSocket connection whenever possible.</li>
<li>Keep a semi-constant WebSocket connection, perhaps connecting every x minutes for a set period of
time.</li>
<li>Do not use WebSockets and only query the REST API.</li>
</ol>
<p>Polling a REST endpoint is inherently inefficient and therefore should only be done with a high interval,
ranging from a few minutes to a few days. If a client requires information more often than that,
then a WebSocket connection should be considered.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="34-http">3.4 HTTP<a href="#34-http" class="hash-link" aria-label="Direct link to 3.4 HTTP" title="Direct link to 3.4 HTTP">​</a></h3>
<p>HTTP/1.1 is the minimum required version that polyproto servers and clients must implement.
Implementing HTTP/2 and HTTP/3 is strongly recommended for all use cases, as both versions of the
protocol introduce significant performance improvements over HTTP/1.1 with HTTP/3 reducing latency
and improving performance the most, especially over lossy networks.</p>
<p>Future versions of the polyproto specification may mandate the implementation of HTTP/2.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="35-internet-protocol-ip">3.5 Internet Protocol (IP)<a href="#35-internet-protocol-ip" class="hash-link" aria-label="Direct link to 3.5 Internet Protocol (IP)" title="Direct link to 3.5 Internet Protocol (IP)">​</a></h3>
<p>Support for both versions 4 and 6 of the Internet Protocol (IPv4 and IPv6) is mandatory for
polyproto client and server software. Real-world availability of both versions of the Internet
Protocol in polyproto should happen on a best-effort basis.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Explanation</div><div class="admonitionContent_BuS1"><p>We do not mandate that access to a polyproto server must be possible over both IPv4 and IPv6
as most of the world is not sufficiently IPv6 capable. We do, however, mandate that software
written to support polyproto must be capable of handling traffic over both IPv4 and IPv6, should
both versions of the Internet Protocol be available to the software at runtime.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="36-compression">3.6 Compression<a href="#36-compression" class="hash-link" aria-label="Direct link to 3.6 Compression" title="Direct link to 3.6 Compression">​</a></h3>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Unfinished</div><div class="admonitionContent_BuS1"><p>As of beta.1 of the polyproto protocol specification, this section is unfinished. Expect this
section to receive content in future beta releases of the protocol spec.</p></div></div>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>TODO; Here&#x27;s a TL;DR:</div><div class="admonitionContent_BuS1"><ul>
<li>zstd level 5-13 recommended for realtime</li>
<li>higher zstd levels recommended for events such as resumed etc.</li>
<li>zstd must be offered on gateway server</li>
<li>zstd must be offered on http api</li>
<li>uncompressed available (but why would you do that)</li>
</ul></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-federated-identity">4. Federated identity<a href="#4-federated-identity" class="hash-link" aria-label="Direct link to 4. Federated identity" title="Direct link to 4. Federated identity">​</a></h2>
<p>The federation of actor identities allows users to engage with foreign servers as if they were their
home servers. For example, in polyproto-chat, an actor can send direct messages to users from a
different server or join the guilds of other servers.</p>
<p>Identity certificates defined in sections <a href="#6-cryptography-and-id-certs">#6. Cryptography and ID-Certs</a>
and <a href="#61-home-server-signed-certificates-for-public-client-identity-keys-id-cert">#6.1 Home server signed certificates for public client identity keys (ID-Cert)</a>
are employed to sign messages that the actor sends to other servers.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Using one identity for several polyproto implementations</div><div class="admonitionContent_BuS1"><p>An actor can choose to use the same identity for multiple polyproto implementations. Read
<a href="#9-services">section #9</a> for more information.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You can read more about identity certificates in <a href="#6-cryptography-and-id-certs">section #6</a>.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-authentication">4.1 Authentication<a href="#41-authentication" class="hash-link" aria-label="Direct link to 4.1 Authentication" title="Direct link to 4.1 Authentication">​</a></h3>
<p>The core polyproto specification does not contain a strict definition of authentication procedures
and endpoints. This allows for a wide range of authentication methods to be used. However, if
implementations want to closely interoperate with each other, they should highly consider
implementing the <a href="/docs/protocols/auth">polyproto-auth</a> standard for authenticating on home servers and
foreign servers alike.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Close interoperation is only possible if all involved polyproto implementations have an
overlapping set of supported authentication methods. Therefore, it is highly recommended to implement
and use the polyproto-auth standard, unless your use case requires a different
authentication method. Of course, other authentication methods can be implemented in addition to
polyproto-auth.</p></div></div>
<p>When successfully authenticated, a client receives a session token, which can then be used to
access authenticated routes on the REST API and to establish a WebSocket connection. Each ID-Cert
can only have one active session token at a time.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>About session tokens</div><div class="admonitionContent_BuS1"><p>Session tokens are used to authenticate a user over a longer period of time, instead of for
example, requiring the user to solve a challenge string every time they want to access a
protected route.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="411-authenticating-on-a-foreign-server">4.1.1 Authenticating on a foreign server<a href="#411-authenticating-on-a-foreign-server" class="hash-link" aria-label="Direct link to 4.1.1 Authenticating on a foreign server" title="Direct link to 4.1.1 Authenticating on a foreign server">​</a></h4>
<p>Regardless of the authentication method used, the foreign server must verify the actor&#x27;s identity
before allowing them to perform any actions. This verification must be done by proving the cryptographic
connection between an actors&#x27; home server&#x27;s public identity key and the actor&#x27;s ID-Cert through
ID-Cert signature verification.</p>
<p>Before a foreign actor is allowed to send messages on the server, the server must also check with
the actor&#x27;s home server to ensure that the ID-Cert has not been revoked. See <a href="#641-verifying-that-a-newly-retrieved-id-cert-is-not-out-of-date">section 6.4.1</a>
for information on how this is done.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="412-sensitive-actions">4.1.2 Sensitive actions<a href="#412-sensitive-actions" class="hash-link" aria-label="Direct link to 4.1.2 Sensitive actions" title="Direct link to 4.1.2 Sensitive actions">​</a></h4>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>Deprecation notice</div><div class="admonitionContent_BuS1"><h1>Challenge strings will be removed soon.</h1><p>Their concept has been thought out further and implemented in different ways. Challenge strings are
no longer needed. This section will be removed soon.</p><p>The API documentation already reflects this change; expect the protocol specification to reflect
these changes in upcoming beta versions of polyproto.</p><p>TODO: Better describe &quot;Sensitive-Solution&quot; instead.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Sensitive actions require a second factor of authentication, apart from the actor&#x27;s
private key. This second factor can be anything from a password to TOTP or hardware keys, depending
on the authentication method or standard used.</p><p>If this is not done, a malicious user who gained access to an actors&#x27; private key can lock that
actor out of their account entirely, as the malicious user could <a href="#714-early-revocation-of-id-certs">revoke the actors&#x27; other ID-Certs</a>,
and thus prevent the actor from logging in again.</p></div></div>
<p>Sensitive actions include, but are not limited to:</p>
<ul>
<li>Generating a new ID-Cert</li>
<li>Revoking an ID-Cert</li>
<li>Changing the actors&#x27; federation ID</li>
<li>Changing the actors&#x27; other factors of authentication</li>
<li>Server administration actions</li>
<li>Deleting encrypted private key material from a home server</li>
</ul>
<p>HTTP API routes marked as sensitive actions require a header <code>X-P2-Sensitive-Solution</code>, where the
header value represents the second factor of authentication chosen.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example</div><div class="admonitionContent_BuS1"><p>If the chosen second factor of authentication is TOTP, the value of this header is the current
TOTP verification code. If the chosen second factor of authentication is a password, then the
value of this header is to be that password.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-challenge-strings">4.2 Challenge strings<a href="#42-challenge-strings" class="hash-link" aria-label="Direct link to 4.2 Challenge strings" title="Direct link to 4.2 Challenge strings">​</a></h3>
<p>Servers use challenge strings to verify an actor&#x27;s private identity key
possession without revealing the private key itself. These strings, ranging from 32 to 256
UTF-8 characters, have a UNIX timestamp lifetime. If the current timestamp surpasses this
lifetime, the challenge fails. The actor signs the string, sending the signature and their
ID-Cert to the server, which then verifies the signature&#x27;s authenticity.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Challenge strings provide a different set of security guarantees than <a href="#412-sensitive-actions">sensitive actions</a>
do. They are not to be used interchangeably.</p></div></div>
<p>All challenge strings and their responses created must be made
public to ensure that a chain of trust can be maintained. A third party should be able to verify that
the challenge string, which authorized a specific change in data, was signed by the
correct private key. The API routes needed to verify challenges as an outsider are documented in the
<a href="https://apidocs.polyproto.org" target="_blank" rel="noopener noreferrer">API documentation</a>.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>For public-facing polyproto implementations, it is recommended to use a challenge string length
of at least 64 characters, including at least one character from each of the alphanumeric
character classes (<code>[a-zA-Z0-9]</code>). Server implementations should ensure that challenge strings
are unique per actor. If this is not the case, actors could potentially be the target of replay attacks.</p></div></div>
<p>Challenge strings can counteract replay attacks. Their uniqueness ensures that even identical requests
have different signatures, preventing malicious servers from successfully replaying requests.</p>
<p>Accessing a challenge string protected route is done as follows:</p>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-protection-against-misuse-by-malicious-home-servers">4.3 Protection against misuse by malicious home servers<a href="#43-protection-against-misuse-by-malicious-home-servers" class="hash-link" aria-label="Direct link to 4.3 Protection against misuse by malicious home servers" title="Direct link to 4.3 Protection against misuse by malicious home servers">​</a></h3>
<p>To protect users from misuse by malicious home servers, a mechanism is needed to prevent home
servers from generating federation tokens for users without their consent and knowledge.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Potential misuse scenario</div><div class="admonitionContent_BuS1"><p>A malicious home server can potentially request a federation token on behalf of one of its
users, and use it to generate a session token on the actor&#x27;s behalf. The malicious server can
then impersonate the actor on another server, as well as read unencrypted data (such as messages,
in the context of a chat application) sent on the other server.</p></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>The above scenario is not unique to polyproto and rather a problem other federated
services/protocols, like ActivityPub, have as well. There is no real solution to this problem.
However, it can be mitigated a bit by making it more difficult for malicious home servers to do
something like this without the actor noticing.</p></div></div>
<p>Polyproto servers need to inform users of new sessions. This visibility hampers malicious home
servers, but does not solve the issue of them being able to create federation tokens for servers the
actor does not connect to. This is because, naturally, users cannot receive notifications without a
connection. Clients re-establishing server connections must be updated on any new sessions
generated during their absence. The <code>NEW_SESSION</code> gateway event must be dispatched to all sessions,
excluding the new session. The <code>NEW_SESSION</code> event&#x27;s stored data can be accessed in the
<a href="https://http.cat/404" target="_blank" rel="noopener noreferrer">Gateway Events documentation</a>.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>With proper safety precautions and strong encryption, it is extremely unlikely for a malicious
server to be able to listen in on encrypted conversations, without all users in that
conversation noticing. When implementing the polyproto-mls P2 extension, MLS&#x27;s forward secrecy
guarantees ensure that, in theory, a malicious session cannot decrypt any messages sent before
its&#x27; join epoch. If secrecy or confidentiality are of concern, users should host their own home
server and use end-to-end encryption, such as polyproto-mls.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-federation-ids-fids">5. Federation IDs (FIDs)<a href="#5-federation-ids-fids" class="hash-link" aria-label="Direct link to 5. Federation IDs (FIDs)" title="Direct link to 5. Federation IDs (FIDs)">​</a></h2>
<p>Every client requires an associated actor identity. Actors are distinguished by a unique federation
ID (FID). FIDs consist of a local name, which is unique per instance, and the instance&#x27;s root domain.
This combination ensures global uniqueness.</p>
<p>FIDs used in public contexts are formatted as <code>actor@optionalsubdomain.domain.tld</code> and are case-insensitive.</p>
<p>FIDs consist of the following parts:</p>
<table><thead><tr><th>Part</th><th>Name</th><th>Description</th></tr></thead><tbody><tr><td><code>actor</code></td><td><a name="def-local-name" id="def-local-name"></a>&quot;Local Name&quot; or &quot;Common Name&quot;</td><td>Must be unique on each instance.</td></tr><tr><td><code>@</code></td><td><a name="def-separator" id="separator"></a>&quot;Separator&quot;</td><td>Separates local name from domain name</td></tr><tr><td><code>optionalsubdomain.domain.tld</code></td><td><a name="def-domain-name" id="def-domain-name"></a>&quot;Domain Name&quot;</td><td>Includes top-level domain, second-level domain and other subdomains. Address which the actors&#x27; home server can be reached at.</td></tr></tbody></table>
<p>The following regular expression can be used to validate actor IDs: <code>\b([a-z0-9._%+-]+)@([a-z0-9-]+(\.[a-z0-9-]+)*)$</code>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The above regular expression is flavored for the Rust programming language, but can be easily
adapted to other languages.</p></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Validating a federation ID with the above regex does not guarantee that the ID is valid. It only
indicates that the federation ID is formatted correctly.</p></div></div>
<p>For all intents and purposes, a federation ID is a display of identity. However, verifying identity
claims is crucial. See <a href="#61-home-server-signed-certificates-for-public-client-identity-keys-id-cert">Section #6.1</a>
and <a href="#621-message-verification">Section #6.2.2</a> for more information.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-cryptography-and-id-certs">6. Cryptography and ID-Certs<a href="#6-cryptography-and-id-certs" class="hash-link" aria-label="Direct link to 6. Cryptography and ID-Certs" title="Direct link to 6. Cryptography and ID-Certs">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="61-home-server-signed-certificates-for-public-client-identity-keys-id-cert">6.1 Home server signed certificates for public client identity keys (ID-Cert)<a href="#61-home-server-signed-certificates-for-public-client-identity-keys-id-cert" class="hash-link" aria-label="Direct link to 6.1 Home server signed certificates for public client identity keys (ID-Cert)" title="Direct link to 6.1 Home server signed certificates for public client identity keys (ID-Cert)">​</a></h3>
<p>The ID-Cert, an <a href="https://en.wikipedia.org/wiki/X.509" target="_blank" rel="noopener noreferrer">X.509</a> certificate, validates a public actor
identity key. It is an actor-generated CSR (<a href="https://en.wikipedia.org/wiki/Certificate_signing_request" target="_blank" rel="noopener noreferrer">Certificate Signing Request</a>),
signed by a home server, encompassing actor identity information and the client&#x27;s public identity key.
Clients can get an ID-Cert in return for a valid and well-formed CSR. Generating a new ID-Cert is
considered a <a href="#412-sensitive-actions">sensitive action</a> and therefore should require a second factor
of authentication.</p>
<p>A CSR in the context of polyproto will be referred to as an ID-CSR. ID-CSRs are DER- or PEM-encoded
<a href="https://datatracker.ietf.org/doc/html/rfc2986" target="_blank" rel="noopener noreferrer">PKCS #10</a> CSRs, with a few additional requirements.</p>
<p>All ID-Certs are valid X.509 v3 certificates. However, not all X.509 v3 certificates are valid ID-Certs.</p>
<p>ID-Certs form the basis of message signing and verification in polyproto.
They are used to verify the identity of a client and to verify the integrity of messages sent by a
client.</p>
<p>An ID-CSR includes the following information, according to the X.509 standard:</p>
<ul>
<li>The public identity key of the client.</li>
<li>A polyproto Distinguished Name (<code>pDN</code>) &quot;subject&quot;, describing the actor the certificate is
issued to. The <code>pDN</code> must be formatted according to <a href="#6111-polyproto-distinguished-name-pdn">Section 6.1.1.1</a>.</li>
<li>The signature algorithm used to sign the certificate.</li>
<li>The signature of the certificate, generated by using the entities&#x27; private identity key.</li>
<li>A version identifier, specifying the version of X.509 certificate used. See <a href="#611-structure-of-an-id-cert">chapter 6.1.1</a>
for a specification of what the version field must look like.</li>
<li>A list of X.509 capabilities which the actor requests for their certificate. See <a href="#6112-extensions-and-constraints">chapter 6.1.1.2</a>
for a specification of allowed, required and forbidden capabilities.</li>
</ul>
<p>When signing an ID-CSR, the home server must verify the correctness of all claims presented in the CSR.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>&quot;Important&quot;</div><div class="admonitionContent_BuS1"><p>All entities receiving an ID-Cert MUST inspect the certificate for correctness and validity.
This includes checking whether the signature matches the certificates&#x27; contents and checking the
certificate&#x27;s validity period.</p></div></div>
<p>Actors must use a separate ID-Cert for each client or session they use. Separating ID-Certs
limits the potential damage a compromised ID-Cert can cause.</p>
<p>For two implementations of polyproto to be interoperable, they must support an overlapping set of
digital signature algorithms. See <a href="#65-cryptographic-specifications">Section 6.5</a> for more
information on cryptographic specifications.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="611-structure-of-an-id-cert">6.1.1 Structure of an ID-Cert<a href="#611-structure-of-an-id-cert" class="hash-link" aria-label="Direct link to 6.1.1 Structure of an ID-Cert" title="Direct link to 6.1.1 Structure of an ID-Cert">​</a></h4>
<p>The ID-Cert is a valid X.509 certificate, and as such, it has a specific structure. The structure of
an X.509 certificate is defined in <a href="https://tools.ietf.org/html/rfc5280" target="_blank" rel="noopener noreferrer">RFC5280</a>.
ID-Certs encompass a subset of the structure of an X.509 certificate.</p>
<p>ID-Certs have the following structure:</p>
<table><thead><tr><th>Field Description</th><th>Special requirements, if any</th><th>X.509 equivalent</th></tr></thead><tbody><tr><td>Correctly formatted Name attribute, according to <a href="#6111-polyproto-distinguished-name-pdn">#6.1.1.1</a></td><td><a href="#6111-polyproto-distinguished-name-pdn">polyproto Distinguished Name</a></td><td>Issuer Name</td></tr><tr><td>Correctly formatted Name attribute, according to <a href="#6111-polyproto-distinguished-name-pdn">#6.1.1.1</a></td><td><a href="#6111-polyproto-distinguished-name-pdn">polyproto Distinguished Name</a></td><td>Subject Name</td></tr><tr><td>A unique, numeric identifier for the certificate, used by the CA to identify this certificate.</td><td>Must be unique across all certificates issued by a home server. 64-bit unsigned integer.</td><td>Serial Number</td></tr><tr><td>The algorithm used to sign the certificate.</td><td></td><td>Certificate Signature Algorithm &amp; Signature Algorithm ID</td></tr><tr><td>The signature of the certificate, generated by using the home servers&#x27; private identity key.</td><td></td><td>Certificate Signature</td></tr><tr><td>The expiry date of the certificate.</td><td>Time must not be after expiry date of the home server&#x27;s root certificate</td><td>Validity period: Not After</td></tr><tr><td>Certificate validity period starting date</td><td>Time must not be before the home server&#x27;s root certificate was generated</td><td>Validity period: Not Before</td></tr><tr><td>X.509 Version Number (v3)</td><td>polyproto only uses Version 3 X.509 certificates.</td><td>Version Number</td></tr><tr><td>The public identity key of the client.</td><td></td><td>Subject Public Key Info: Subject Public Key</td></tr><tr><td>The public key algorithm used to generate the client&#x27;s public identity key.</td><td></td><td>Subject Public Key Info: Public Key Algorithm</td></tr><tr><td>The session ID of the client.</td><td>No two valid certificates for one session ID can exist. Session IDs have to be unique per actor.</td><td>Subject Unique Identifier</td></tr><tr><td>Extensions</td><td><a href="#6112-extensions-and-constraints">Extensions and Constraints</a></td><td>Extensions</td></tr></tbody></table>
<p>The domain components (<code>dc</code>) in the &quot;issuer&quot; and &quot;subject&quot; fields must be equal and in the same order.
A certificate may not be treated as valid otherwise. X.509 semantics describing the correct ordering
of domain components apply.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="6111-polyproto-distinguished-name-pdn">6.1.1.1 polyproto Distinguished Name (<code>pDN</code>)<a href="#6111-polyproto-distinguished-name-pdn" class="hash-link" aria-label="Direct link to 6111-polyproto-distinguished-name-pdn" title="Direct link to 6111-polyproto-distinguished-name-pdn">​</a></h5>
<p>polyproto Distinguished Names (<code>pDNs</code>) are a subset of an X.509 certificate&#x27;s <a href="https://ldap.com/ldap-dns-and-rdns/" target="_blank" rel="noopener noreferrer">distinguished
Names (<code>DNs</code>)</a>, defined by the LDAP Data Interchange Format (LDIF).
The <code>DN</code> is a sequence of <a href="https://ldap.com/ldap-dns-and-rdns/" target="_blank" rel="noopener noreferrer">relative distinguished names (<code>RDNs</code>)</a>.</p>
<p>A <code>pDN</code> must meet all the following requirements:</p>
<ul>
<li>If the <code>pDN</code> describes an actor, it must have a &quot;common name&quot; attribute. The
common name must be the <a href="#5-federation-ids-fids">local name</a> of the actor. In the case of an actor
with an FID of <code>xenia@example.com</code>, the local name would be <code>xenia</code>. If the <code>pDN</code> describes a
home server, the &quot;common name&quot; attribute must not be present.</li>
<li>Must have at least one domain component <code>dc</code>, specifying the domain name under which the home
server can be reached. This includes the home server&#x27;s top- and second-level domains, as well as
all other subdomains, if present. If the home server does not have a sub- or top-level domain, the
<code>dc</code> fields for these components should be omitted.</li>
<li>If the <code>pDN</code> describes an actor, the <code>pDN</code> must include the <code>UID</code>
(<a href="https://en.wikipedia.org/wiki/Object_identifier" target="_blank" rel="noopener noreferrer">OID</a> 0.9.2342.19200300.100.1.1) <strong>and</strong>
<code>uniqueIdentifier</code> (<a href="https://en.wikipedia.org/wiki/Object_identifier" target="_blank" rel="noopener noreferrer">OID</a> 0.9.2342.19200300.100.1.44)
fields.<!-- -->
<ul>
<li><code>UID</code> field must be equal to the federation ID of the actor, e.g., <code>actor@domainname-of-home server.example.com</code>.</li>
<li><code>uniqueIdentifier</code> field must be a <a href="#6113-session-ids">Session ID</a>.</li>
</ul>
</li>
<li>Can have other attributes if the additional attributes do not conflict with the above
requirements. Additional attributes might be ignored by other home servers and other clients unless
specified otherwise in a polyproto extension. Additional attributes not part of a polyproto
extension must be non-critical X.509 extensions.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="6112-extensions-and-constraints">6.1.1.2 Extensions and constraints<a href="#6112-extensions-and-constraints" class="hash-link" aria-label="Direct link to 6.1.1.2 Extensions and constraints" title="Direct link to 6.1.1.2 Extensions and constraints">​</a></h5>
<p>The following constraints must be met by ID-Certs:</p>
<ul>
<li>If the ID-Cert is a root certificate<!-- -->
<ul>
<li>It must have the <code>CA</code> flag set to <code>true</code>. The path length constraint must be present and set
to <code>0</code>.</li>
<li>It must have the <code>keyCertSign</code> key usage flag set to <code>true</code>.</li>
</ul>
</li>
<li>If the ID-Cert is an actor certificate<!-- -->
<ul>
<li>It must have the <code>CA</code> flag set to <code>false</code> or omitted.</li>
<li>It must have the <code>keyCertSign</code> key usage flag set to <code>false</code> or omitted.</li>
<li>It must have the <code>digitalSignature</code> key usage flag OR <code>contentCommitment</code> flags set to <code>true</code>.</li>
</ul>
</li>
</ul>
<p><a href="https://cryptography.io/en/latest/x509/reference/#cryptography.x509.KeyUsage" target="_blank" rel="noopener noreferrer">Key Usage Flags</a> and
<a href="https://cryptography.io/en/latest/x509/reference/#cryptography.x509.BasicConstraints" target="_blank" rel="noopener noreferrer">Basic Constraints</a>
are critical extensions. Therefore, if any of these X.509 extensions are present, they must be marked
as &quot;critical.&quot; ID-Certs not adhering to this standard must be treated as malformed.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="6113-session-ids">6.1.1.3 Session IDs<a href="#6113-session-ids" class="hash-link" aria-label="Direct link to 6.1.1.3 Session IDs" title="Direct link to 6.1.1.3 Session IDs">​</a></h5>
<p>The session ID is an <a href="https://en.wikipedia.org/wiki/ASN.1" target="_blank" rel="noopener noreferrer"><code>ASN.1</code></a> <a href="https://en.wikipedia.org/wiki/IA5STRING" target="_blank" rel="noopener noreferrer"><code>Ia5String</code></a>
chosen by the actor requesting the ID-Cert. It is used to uniquely identify a session. The session
ID must be unique for each certificate issued to that actor. A session ID can be reused if the
session belonging to that session ID has become invalid. Session ID reuse in this case also applies
when a different ID-Cert wants to use the same session ID, provided that the session ID is not currently
in use. If the session ID is currently in use, the actor requesting the ID-Cert must select a different
session ID, as session IDs must not be overridden silently.</p>
<p>Session IDs are 1-32 characters long and. They can contain any character permitted by the <code>ASN.1</code>
<code>IA5String</code> type.</p>
<p>Session IDs can be used to identify a session across devices or to detect if a new, perhaps
malicious session has been created.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="612-necessity-of-id-certs">6.1.2 Necessity of ID-Certs<a href="#612-necessity-of-id-certs" class="hash-link" aria-label="Direct link to 6.1.2 Necessity of ID-Certs" title="Direct link to 6.1.2 Necessity of ID-Certs">​</a></h4>
<p>The addition of a certificate is necessary to prevent a malicious foreign server from abusing public
identity key caching to impersonate an actor. Consider the following example, which employs foreign
server public identity key caching but no home server-issued identity key certificates:</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Potential misuse scenario</div><div class="admonitionContent_BuS1"><p>A malicious foreign server B can fake a message from Alice.
(Home server: Server A) to Bob (Home Server: Server B), by generating a new identity key pair
and using it to sign the malicious message. The foreign server then sends that message to Bob,
who will then request Alice&#x27;s public identity key from Server B, who will then send Bob the
malicious public identity key. Bob will succeed in verifying the signature of the message, and
not notice that the message has been crafted by a malicious server.</p></div></div>
<p>The above scenario is not possible with home server-issued identity key certificates, as the
malicious server cannot generate an identity key pair for Alice, which is signed by Server A.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="613-key-rotation">6.1.3 Key rotation<a href="#613-key-rotation" class="hash-link" aria-label="Direct link to 6.1.3 Key rotation" title="Direct link to 6.1.3 Key rotation">​</a></h4>
<p>A session can choose to regenerate their ID-Cert at any time. This is done by taking an identity
key pair, using the private key to generate a new CSR, and sending the new Certificate Signing
Request to the home server. The home server will then generate the new ID-Cert, given that
the CSR is valid. Actors can only regenerate ID-Certs for their current session, identified by their
session ID and session token. Other sessions can only be invalidated by <a href="#614-early-revocation-of-id-certs">revoking them</a>.
Re-generating an ID-Cert is a <a href="#412-sensitive-actions">sensitive action</a>, performed by using the
appropriate API route.</p>
<p>Home servers must keep track of the ID-Certs of all users (and their clients) registered on them
and must offer a clients&#x27; ID-Cert for a given timestamp on request. This is to ensure messages
sent by users, even ones sent a long time ago, can be verified by other servers and their users.
This is because the public key of an actor likely changes over time, and users must sign all messages
they send to servers.</p>
<p>Users must hold on to all of their past key pairs, as they might need them to
<a href="#7-migrations">migrate their account in the future</a>. How this is done is specified in
<a href="#63-private-key-loss-prevention-and-private-key-recovery">section 6.3: Private key loss prevention and private key recovery</a>.</p>
<p>The lifetime of an actor ID-Cert should be limited to a maximum of 60 days. This is to ensure that even
in a worst-case scenario, a compromised ID-Cert can only be used for a limited amount of time. &quot;Renewing&quot;
an ID-Cert consists of:</p>
<ol>
<li>Revoking the old ID-Cert</li>
<li>Requesting a new ID-Cert with the same <a href="#6113-session-ids">session ID</a> as the old ID-Cert.</li>
</ol>
<p>A client that has this second factor of authentication stored
should renew the ID-Cert of the authenticated actor without further interaction.</p>
<p>Server ID-Certs should be rotated way less often (every 1-3 years). Only rotate a server ID-Cert
if it is suspected to be compromised, is lost, or has expired.</p>
<!-- -->
<p><em>Fig. 2: Sequence diagram depicting the process of a client that uses a CSR to request a new ID-Cert
from their home server.</em></p>
<p>A server identity key&#x27;s lifetime might come to an early or unexpected end, perhaps due to some sort
of leak of the corresponding private key. When this happens, the server should generate a new
identity key pair and broadcast the
<a href="https://http.cat/404" target="_blank" rel="noopener noreferrer"><code>SERVER_KEY_CHANGE</code></a> gateway event
to all clients. Clients must request new ID-Certs through a CSR. Should a client be offline at the time
of the key change, it must be informed of the change upon reconnection.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="614-early-revocation-of-id-certs">6.1.4 Early revocation of ID-Certs<a href="#614-early-revocation-of-id-certs" class="hash-link" aria-label="Direct link to 6.1.4 Early revocation of ID-Certs" title="Direct link to 6.1.4 Early revocation of ID-Certs">​</a></h4>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>A note about CRLs</div><div class="admonitionContent_BuS1"><p>It is common for systems relying on X.509 certificates for user authentication to use Certificate
Revocation Lists (CRLs) to keep track of which certificates are no longer valid. This is done to
prevent a user from using a certificate that has been revoked.</p><p>CRLs are difficult to implement well, often requiring many resources to keep up to date, and
are also not always reliable. OCSP (Online Certificate Status Protocol) is a more modern, reliable
and easier to implement alternative. Still, it potentially requires many resources to
keep up with demand while introducing potential privacy concerns.</p><p>polyproto inherently mitigates some of the possible misuse of a revoked certificate, as the validity
of a certificate is usually checked by many parties. In particular, the revocation process is
initiated by the actor themselves, the actor already lets all servers they are connected to know
that the certificate in question is no longer valid.</p><p>polyproto does not require the use of CRLs or OCSP.</p></div></div>
<p>An ID-Cert can be revoked by the home server or the actor at any time. This can be done for various
reasons, such as</p>
<ul>
<li>a suspected leak of the private identity key</li>
<li>the changing of an actor&#x27;s federation identifier.</li>
<li>the changing of an actor&#x27;s federation identifier.</li>
<li>keeping the number of ID-Certs associated with an actor within a desired boundary</li>
</ul>
<p>When an ID-Cert is revoked, the server must revoke the session associated with the revoked ID-Cert.
Revoking an ID-Cert is considered a <a href="#412-sensitive-actions">sensitive action</a> and therefore should
require a second factor of authentication.</p>
<!-- -->
<p>:::bug &quot;TODO&quot;</p>
<p>The following questions are still open:</p>
<ul>
<li>Should actors always be able to revoke the ID-Cert they are sending the revocation message with
without needing to complete a sensitive action?<!-- -->
<ul>
<li>Currently, I cannot see any reason that would speak against this.</li>
</ul>
</li>
<li>How can actors remain in control of their keys? If revocations need to be signed by the server,
then the server has more authority over keys than the actor does<!-- -->
<ul>
<li>Revocations should likely never have to be signed by the server. Either that, or it does,
but the <a href="#2-trust-model">trust model assumptions</a> apply.</li>
</ul>
</li>
</ul>
<p>:::</p>
<p>If the ID-Cert revocation was initiated by an actor, that actor must inform other servers of this
revocation <strong>before</strong> sending further messages to those servers.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The above paragraph is true for both foreign and home servers. The API routes associated with
revoking an ID-Cert are the same regardless of the server type.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Revocation detection</div><div class="admonitionContent_BuS1"><p>For information on how revocation detection is supposed to be handled, see <a href="#64-caching-of-id-certs">section 6.4</a>.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="62-actor-identity-keys-and-message-signing">6.2 Actor identity keys and message signing<a href="#62-actor-identity-keys-and-message-signing" class="hash-link" aria-label="Direct link to 6.2 Actor identity keys and message signing" title="Direct link to 6.2 Actor identity keys and message signing">​</a></h3>
<p>As briefly mentioned in section <a href="#4-federated-identity">#4</a>, users must hold on to an identity key pair
at all times. This key pair is used to represent an actor&#x27;s identity and to verify
message integrity by having an actor sign all messages they send with their
private identity key. The key pair is generated by the actor. An actor-generated identity key
certificate signing request (CSR) is sent to the actor&#x27;s home server when first connecting to the
server with a new session or when rotating keys. The key is stored in the client&#x27;s local storage.
Upon receiving a new identity key CSR, a home server will sign this CSR and send the resulting ID-Cert
to the client. This certificate is proof that the home server attests to the client&#x27;s key. Read
<a href="#61-home-server-signed-certificates-for-public-client-identity-keys-id-cert">section 6.1</a> for more
information about the certificate.</p>
<p>The private key from the key pair that the server has generated an ID-Cert for will be used to create
digital signatures for the contents of all messages sent by this session. This digital signature must
be attached to the message itself so that other actors can verify the integrity of the message
contents.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>polyproto does not define what messages themselves look like, apart from this hard requirement.
The format of a message is up to polyproto extensions and implementations to define.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="621-message-verification">6.2.1 Message verification<a href="#621-message-verification" class="hash-link" aria-label="Direct link to 6.2.1 Message verification" title="Direct link to 6.2.1 Message verification">​</a></h4>
<p>To ensure message integrity through signing, clients and servers must verify
message signatures. This involves cross-checking the message signature against the sender&#x27;s
ID-Cert and the sender&#x27;s home server&#x27;s ID-Cert while also confirming the validity of the
ID-Cert attached to the message and ensuring its public key matches the sender&#x27;s.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Signature verification must always be &quot;strict,&quot; meaning that signature schemes producing malleable
signatures and <a href="https://en.wikipedia.org/wiki/Weak_key" target="_blank" rel="noopener noreferrer">weak public keys</a> must be rejected.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example</div><div class="admonitionContent_BuS1"><p>Say we have two actors. Alice, who is registered on Server A, and Bob, who is registered
on Server B. Alice and Bob <strong>are having a conversation on Server B</strong>. Given a signed message from
Alice, such as Bob would receive from Server B, the process of verifying the signature would look
like this:</p><p><em>Fig. 3: Sequence diagram of a successful message signature verification.</em></p></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>You should read about the details of ID-Cert lookup load distribution via caching and why
Bob should first try to request Alice&#x27;s certificate from Server B instead of Alice&#x27;s home
server (Server A) in the <a href="#64-caching-of-id-certs">corresponding section of this protocol specification</a>.
Understanding both sections is crucial for building secure, scalable, and compliant
implementations of polyproto.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>A failed signature verification does not always mean that the message is invalid. It may be that
the actor&#x27;s identity key has changed, and that Server B has not yet received the new public
identity key for some reason. However, if the signature cannot be verified at a certain time,
this information must be communicated to the actor performing the verification.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="622-handling-of-external-messages">6.2.2 Handling of external messages<a href="#622-handling-of-external-messages" class="hash-link" aria-label="Direct link to 6.2.2 Handling of external messages" title="Direct link to 6.2.2 Handling of external messages">​</a></h4>
<p>In the context of federation with other federation protocols, such as ActivityPub, it is possible
for actors to receive messages that do not have a signature attached to them. If a P2 extension
explicitly allows for this, it is possible for a polyproto server to forward such messages to
clients. If a P2 extension does not explicitly allow for this, both servers and clients must
reject such messages.</p>
<p>Before a polyproto server forwards such a message to clients, it must add an &quot;external&quot; property to
the message object. If possible in the data format used, this property should be set to a boolean
value of <code>true</code> or a value that can be interpreted in an equivalent manner.
This property must be passed along to the client or clients receiving the message.</p>
<p>If the actor receiving this external message is human or otherwise sentient, the client application
should inform the actor that the message is external and that the message has not been signed by
the sender. External messages should be distinguishable from signed messages at first glance, especially
when viewed through a client application.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="63-private-key-loss-prevention-and-private-key-recovery">6.3 Private key loss prevention and private key recovery<a href="#63-private-key-loss-prevention-and-private-key-recovery" class="hash-link" aria-label="Direct link to 6.3 Private key loss prevention and private key recovery" title="Direct link to 6.3 Private key loss prevention and private key recovery">​</a></h3>
<p>As described in previous sections, actors must hold on to their past identity key pairs, should they
want or need to migrate their account.</p>
<p>Home servers must offer a way for actors to upload and recover their private identity keys while not
having access to the private keys themselves. Private identity keys must be encrypted with
strong passphrases and encryption schemes such as AES before being uploaded to the server.
Authenticated actors can download their encrypted private identity keys from the server at any time.
All encryption and decryption operations must be done client-side.</p>
<p>If any uncertainty about the availability of the home server exists, clients should regularly
download their encrypted private identity keys from the server and store them in a secure location.
Ideally, each client should immediately download their encrypted private identity keys from the
server after connecting. Clients must never store key backups in an unencrypted manner.</p>
<p>Whether an actor uploads their encrypted private identity keys to the server is their own choice.
It is also recommended to back up the encrypted private identity keys in some other secure location.</p>
<p>The APIs for managing encrypted private identity keys are documented in the
<a href="https://apidocs.polyproto.org" target="_blank" rel="noopener noreferrer">API documentation</a>.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Actors can make use of the <a href="#7-migrations">migration APIs</a> to reduce the number of ID-Certs/keys
that they must hold on to to migrate their account in the future.</p><p>For example, if an actor currently has messages signed with 20 different ID-Certs but only uses
2 clients (meaning that the actor always needs two active ID-Certs—one for each client),
the 18 outdated/unused ID-Certs could be consolidated into one ID-Cert through <a href="#72-re-signing-messages">re-signing the messages</a>
made with the outdated ID-Certs with any other ID-Cert.</p><div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>This drastically reduces the number of ID-Certs the actor needs to keep track of and hold on
to, which may make re-signing messages in the future easier.</p><p>However, doing this also introduces additional risks, as the overwhelming majority of the
actor&#x27;s message history is now associated with one ID-Cert. <strong>An accidental leak of the
private identity key of that ID-Cert could likely not be recovered from,</strong> since all associated
messages are potentially under control by those who know the private identity key.</p><p>Actors and polyproto software developers must keep this information in mind, should
consider whether the risks and benefits of this strategy are worth it for their use case and
can introduce additional strategies to manage the number of &quot;relevant&quot; private keys safely.</p></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="64-caching-of-id-certs">6.4 Caching of ID-Certs<a href="#64-caching-of-id-certs" class="hash-link" aria-label="Direct link to 6.4 Caching of ID-Certs" title="Direct link to 6.4 Caching of ID-Certs">​</a></h3>
<p>The caching of ID-Certs is an important mechanism in polyproto to aid in fairly distributing the load
generated by ID-Cert lookups to the servers generating the traffic, not to the server the ID-Cert
is actually from. This practice should help make the operation of low-resource home servers, used
exclusively for hosting identities, more viable.</p>
<p>This section of the protocol definition defines required behaviors related to the correct caching
of ID-Certs for both home servers and clients.</p>
<p>To make this section more understandable, we will bring back the example from section 6.2.1:</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Revisiting the example scenario from section 6.2.1</div><div class="admonitionContent_BuS1"><div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example</div><div class="admonitionContent_BuS1"><p>Say we have two actors. Alice, who is registered on Server A, and Bob, who is registered
on Server B. Alice and Bob <strong>are having a conversation on Server B</strong>. Given a signed message
from Alice, such as Bob would receive from Server B, the process of verifying the signature
would look like this:</p><p><em>Fig. 3: Sequence diagram of a successful message signature verification.</em></p></div></div><p>In the case where <code>alice@server-a.example.com</code> and <code>bob@server-b.example.com</code> are having a
conversation where the communications server is any server other than <code>server-a.example.com</code>,
Bob should request Alice&#x27;s ID-Cert from that server first, instead of from <code>server-a.example.com</code>.</p></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Further notes on why we consider this cached distribution process a good idea</div><div class="admonitionContent_BuS1"><p>Bob&#x27;s client could request Alice&#x27;s public identity key from Server A, instead of Server B.
However, this is discouraged, as it</p><ul>
<li>Generates unnecessary load on Server A; Doing it this way distributes the load of public
identity key requests more fairly, as the server that the message was sent on is the one that
has to process the bulk of public identity certificate requests.</li>
<li>Would expose unnecessary metadata to Server A; Server A does not need to know who exactly
Alice is talking to, and when. Only Server B, Alice, and Bob need to know this information.
Always requesting the public identity key from Server A might expose this information to
Server A.</li>
</ul><p>Clients should only use Server A as a fallback for public identity key verification if Server B
does not respond to the request for Alice&#x27;s public identity key, or if the verification fails
with the public identity key from Server B. Security considerations listed in this section of
the protocol definition ensure that this cached distribution process is safe and trustworthy.</p></div></div>
<p>Both Bob&#x27;s client and Server B should now cache Server A&#x27;s and Alice&#x27;s ID-Certs to avoid having to
request them again.</p>
<p>The TTL (time to live) of these cached items should be relatively short. Recommended values
are between one (1) and twelve (12) hours. Cached ID-Certs must be evicted from
the cache after the TTL has expired. Expired cached ID-Certs must not be used for signature
verification of new messages, even if the client cannot renew its cache. All of this applies to both
servers and clients. The TTL for a certificate&#x27;s cache duration is dictated by the home server
that certificate has been issued by. You can read more on that in
<a href="#641-verifying-that-a-newly-retrieved-id-cert-is-not-out-of-date">subsection 1 of this section</a>.</p>
<div><p>Why not select longer-lived TTLs for cached ID-Certs?</p><p>Suppose that an actor&#x27;s private identity key is compromised. The actor notices this and revokes
their ID-Cert. If the TTL of cached ID-Certs is too long, the compromised ID-Cert might still be
used for signature verification for a long amount of time, even after the ID-Cert has been revoked.
This is a problem in the following hypothetical scenario with the malicious actor &quot;Eve&quot; and the
victim &quot;Alice&quot;:</p><div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Downside of using higher values for a TTL</div><div class="admonitionContent_BuS1"><ol>
<li>One of Alice&#x27;s private identity keys is compromised.</li>
<li>Malicious actor Eve logs onto Server X, which Alice has never connected to before, using
Alice&#x27;s ID-Cert, of which the corresponding private identity key has been compromised.</li>
<li>In the meantime, Alice notices the breach, requesting the revocation of her ID-Cert on
all servers she is connected to.</li>
<li>Server X does not get this revocation message, as Alice does not know about her connection
to Server X, where Eve is impersonating Alice.</li>
<li>Eve can now impersonate Alice on Server X for as long as the TTL of the cached ID-Cert on
Server X has not expired. With a high value, this could be a long time.</li>
</ol></div></div></div>
<p>If the verification fails, Bob&#x27;s client should try to re-request the key from Server B first.
Should the verification fail again, Bob&#x27;s client can try to request Alice&#x27;s public identity key
and ID-Cert from Server A (Alice&#x27;s home server). The signature verification process should then be
retried. Should the verification still not succeed, the message should be treated with extreme
caution.</p>
<!-- -->
<p><em>Fig. 4: Sequence diagram showing how message verification should be handled if the first attempt
to verify the signature fails, continuing the example of a conversation happening on a server
&quot;B&quot; between Bob from a random server and Alice from server A</em></p>
<p>After evicting a cached ID-Cert:</p>
<ul>
<li>A client should request an up-to-date ID-Cert of the target actor from the server where the actor
was last seen by the client.</li>
<li>A server should request an up-to-date ID-Cert from the target actor&#x27;s home server.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>It is <em>not</em> of vital importance that a client requests an ID-Cert of an actor whose ID-Cert has
just been evicted from the cache from the server, where the actor was last seen by the client
<em>precisely</em>. This means that a client application doesn&#x27;t necessarily need to update an internal
state of where that actor has last been seen every single time that actor sends a message somewhere.
This internal state update could instead happen every 5, 30, or even 60 seconds. What <em>is</em>
important, however, is that this state update does eventually happen within a reasonable amount
of time, to help achieve the goal of dynamic server load distribution.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="641-verifying-that-a-newly-retrieved-id-cert-is-not-out-of-date">6.4.1 Verifying that a newly retrieved ID-Cert is not out of date<a href="#641-verifying-that-a-newly-retrieved-id-cert-is-not-out-of-date" class="hash-link" aria-label="Direct link to 6.4.1 Verifying that a newly retrieved ID-Cert is not out of date" title="Direct link to 6.4.1 Verifying that a newly retrieved ID-Cert is not out of date">​</a></h4>
<p>While the goal of achieving dynamic server load distribution to increase the viability of small,
low-resource home servers is a noble one, this goal must not undermine <a href="#2-trust-model">P2s trust model</a>,
which other aspects of the protocol work very hard to uphold. Retrieving ID-Certs from a middleman
introduces a new attack surface that must be mitigated. Consider the following example:</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example attack abusing blind middleman trust</div><div class="admonitionContent_BuS1"><ol>
<li>One of Alice&#x27;s private identity keys is compromised.</li>
<li>Malicious actor Eve logs onto a malicious Server X, which is controlled by Eve, impersonating
Alice by using Alice&#x27;s ID-Cert, of which the corresponding private identity key has been compromised.</li>
<li>In the meantime, Alice notices the breach, requesting the revocation of her ID-Cert on
all servers she is connected to.</li>
<li>Server X does not care for this revocation message, as it is malicious (attacker controlled).</li>
<li>Eventually, the TTL for this compromised certificate expires. Users on Server X contact the
server for the latest certificate of Alice.</li>
<li>Server X responds with the compromised ID-Cert, claiming that this is the most up-to-date
ID-Cert, even though it has been revoked.</li>
<li>Through all users trusting Server X blindly, Eve and Server X can impersonate Alice for as
long as Alice&#x27;s compromised ID-Cert would have been valid for (valid-not-after attribute in X.509
certificates). Until then, users do not notice that this certificate has been revoked and
should no longer be valid.</li>
</ol></div></div>
<p>This kind of attack mentioned above has been considered and mitigated in polyproto. This mitigation
is achieved through API behaviors enabling the fetching of actor ID-Certs with additional information
attached to the response body. The additional information is structured as follows:</p>
<table><thead><tr><th>Field name</th><th>JSON type</th><th>Actual type (if different from JSON type)</th><th>Description</th></tr></thead><tbody><tr><td><code>cacheValidNotBefore</code></td><td>String</td><td>Unsigned 64-bit integer</td><td>UNIX timestamp that specifies the time from which this cache entry may be treated as valid.</td></tr><tr><td><code>cacheValidNotAfter</code></td><td>String</td><td>Unsigned 64-bit integer</td><td>UNIX timestamp that specifies a time until which this cache entry may be treated as valid.</td></tr><tr><td><code>cacheSignature</code></td><td>String</td><td>-</td><td>Signature generated by the home server. This signature can be verified using the home servers&#x27; public identity key. Signature bytes, encoded in <a href="https://en.wikipedia.org/wiki/Hexadecimal" target="_blank" rel="noopener noreferrer">Hexadecimal</a> (base-16).</td></tr><tr><td><code>invalidatedAt</code></td><td>String?</td><td>Unsigned 64-bit integer</td><td>If present, represents a UNIX timestamp at which the certificate was <a href="#614-early-revocation-of-id-certs">invalidated</a> on. Certificate was not prematurely invalidated if not present.</td></tr></tbody></table>
<p>A server generates the <code>cacheSignature</code> by concatenating the serial number of the ID-Cert in
question with the <code>cacheValidNotBefore</code> timestamp, the <code>cacheValidNotAfter</code> timestamp, and the <code>invalidatedAt</code>
timestamp, if present.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>The order in which the concatenation operations are executed is important and must be adhered
to. The order is as follows:</p><p><code>cacheSignature ⋅ cacheValidNotBefore ⋅ cacheValidNotAfter ⋅ (invalidatedAt|&quot;&quot;)¹</code></p><p>¹: The value of invalidatedAt, if present; otherwise, an empty string.</p></div></div>
<p>The resulting string is signed using the home servers private identity key.
Clients must reject certificates of which the <code>cacheSignature</code> can not be verified to be
correct.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Note/Fun fact</div><div class="admonitionContent_BuS1"><p>Note how the cache validity period is determined by the &quot;original&quot; home server and automatically
propagated through—and respected by—every server and client caching the certificate. If another
server tried to manipulate the cache validity period, they would get found out almost immediately.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Concatenation operations are not commutative.</p></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Definition: Concatenation</div><div class="admonitionContent_BuS1"><blockquote>
<p>In formal language theory and computer programming, string concatenation is the operation of
joining character strings end-to-end. For example, the concatenation of &quot;snow&quot; and &quot;ball&quot; is
&quot;snowball&quot;.</p>
</blockquote><p><em>From Wikipedia, The Free Encyclopedia. <a href="https://en.wikipedia.org/w/index.php?title=Concatenation&amp;oldid=1266032132#:~:text=In%20formal%20language,a%20primitive%20notion." target="_blank" rel="noopener noreferrer">Source</a></em></p></div></div>
<p>Because digital signatures rely on asymmetric key cryptography, possession of this server&#x27;s public
identity key allows an actor to validate that a cached ID-Cert is both genuine and up-to-date.</p>
<p>This technique remedies the possibility of caching introducing an additional attack vector, allowing
caching to be used without conflicting with the <a href="#2-trust-model">trust model</a> of polyproto.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Scenarios requiring cache and validity verification</div><div class="admonitionContent_BuS1"><p><strong>Only</strong> the following scenarios <strong>must require</strong> a server to retrieve, validate and supply invalidation
and cache information about a foreign actor&#x27;s ID-Cert:</p><ul>
<li><strong>Sending messages:</strong> Before a foreign actor is allowed to send any messages on the server. This
automatically applies again if the ID-Cert is changed through any means.</li>
<li><strong>ID-Cert request:</strong> When the server receives a request for a foreign actor&#x27;s ID-Cert, the server
must fetch and validate invalidation and cache information about the foreign actor&#x27;s ID-Cert before
completing the request.</li>
</ul></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Scenarios <strong>not</strong> requiring cache and validity verification</div><div class="admonitionContent_BuS1"><p>The following scenarios <strong>must explicitly not require</strong> a server to retrieve, verify or supply invalidation
and cache information about a foreign actor&#x27;s ID-Cert:</p><ul>
<li><strong>Requesting a challenge string:</strong> When a foreign actor requests a challenge string from the server.</li>
<li><strong>Requesting a key trial:</strong> When a foreign actor requests a key trial from the server.</li>
<li><strong>Completing a key trial:</strong> When a foreign actor completes a key trial from the server.</li>
<li><strong>Re-signing messages request:</strong> When a foreign actor requests to re-sign messages on the server.</li>
<li><strong>Re-signing messages abortion request:</strong> When a foreign actor requests to abort the re-signing
of messages on the server.</li>
<li><strong>Re-signing messages commitment:</strong> When a foreign actor commits re-signed messages to the server.</li>
<li><strong>Re-signing messages commitment:</strong> When a foreign actor fetches messages to-be re-signed from
the server.</li>
<li><strong>Requesting a redirect:</strong> When a foreign (&quot;new&quot;) actor asks the server of the &quot;old&quot; server to
set up a redirect to the &quot;new&quot; actor.</li>
<li><strong>Key trial information request:</strong> When an actor requests information about completed key trials
from the foreign actor.</li>
<li><strong>Requesting a home server ID-Cert:</strong> When an actor requests the ID-Cert of a home server — an
action that can only be performed by asking the home server in question directly, that ID-Cert
mustn&#x27;t contain cache and validity information. Since home server ID-Certs are self-signed,
cache and validity information would not benefit anyone.</li>
</ul></div></div>
<p>polyproto implementation must not require cache and validity verification on any route not specified
in the above information block, except if a <a href="#8-protocol-extensions-p2-extensions">p2-extension</a> states
otherwise.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="65-cryptographic-specifications">6.5 Cryptographic specifications<a href="#65-cryptographic-specifications" class="hash-link" aria-label="Direct link to 6.5 Cryptographic specifications" title="Direct link to 6.5 Cryptographic specifications">​</a></h3>
<p>All implementations of polyproto <strong>must</strong> use the Ed25519 digital signature algorithm for signing
messages and generating ID-Certs. The usage of alternative cryptographic algorithms is allowed.
However, certificates and messages must be made available with Ed25519 signatures per default.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="66-best-practices">6.6 Best practices<a href="#66-best-practices" class="hash-link" aria-label="Direct link to 6.6 Best practices" title="Direct link to 6.6 Best practices">​</a></h3>
<p>The following subsections are dedicated to documenting best practices to consider when
implementing polyproto.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="661-signing-keys-and-id-certs">6.6.1 Signing keys and ID-Certs<a href="#661-signing-keys-and-id-certs" class="hash-link" aria-label="Direct link to 6.6.1 Signing keys and ID-Certs" title="Direct link to 6.6.1 Signing keys and ID-Certs">​</a></h4>
<ul>
<li>When a server is asked to generate a new ID-Cert for an actor, it must make sure that the CSR is
valid and, if set, has an expiry date less than or equal to the expiry date of the server&#x27;s own ID-Cert.</li>
<li>Due to the fact that a <code>SERVER_KEY_CHANGE</code> gateway event is bound to generate a large amount of
traffic, servers should only manually generate a new identity key pair when absolutely necessary
and instead select a fitting expiry date interval for their ID-Certs. It might
also be a good idea to stagger the sending of <code>SERVER_KEY_CHANGE</code> gateway events to prevent a
server from initiating a DDoS attack on itself. </li>
<li>When a client or server receives the information that an actor&#x27;s client identity key has been
changed, the client/server in question should update their cached ID-Cert for the actor in
question, taking into account the session ID of the new identity key pair.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="662-home-server-operation-and-design">6.6.2 Home server operation and design<a href="#662-home-server-operation-and-design" class="hash-link" aria-label="Direct link to 6.6.2 Home server operation and design" title="Direct link to 6.6.2 Home server operation and design">​</a></h4>
<ul>
<li>Use a caching layer for your home server to handle the potentially large amount of requests for
ID-Certs without putting unnecessary strain on the database.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="663-private-key-loss-prevention-and-private-key-recovery">6.6.3 Private key loss prevention and private key recovery<a href="#663-private-key-loss-prevention-and-private-key-recovery" class="hash-link" aria-label="Direct link to 6.6.3 Private key loss prevention and private key recovery" title="Direct link to 6.6.3 Private key loss prevention and private key recovery">​</a></h4>
<ul>
<li>It is a good idea for home servers to limit the upload size and available upload slots for encrypted
private identity keys.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-migrations">7. Migrations<a href="#7-migrations" class="hash-link" aria-label="Direct link to 7. Migrations" title="Direct link to 7. Migrations">​</a></h2>
<p>polyproto empowers the end user by defining straightforward mechanisms to change their home server
while preserving their identity, moving messages to another server, or both.</p>
<p>Identity migration allows actors to transparently reassign ownership of their identity and messages
to a new identity. This allows actors to switch home servers while not losing ownership of messages
sent by them.</p>
<p>Message migration allows actors to move messages from one service provider to another in a
tamper-resistant way. This makes it possible for actors to switch service providers, taking some
or all of their messages with them. Which messages can be moved is up to P2 extensions to define,
as it might not always be possible to move all messages. Some messages might be tied to a
specific context, which is unavailable on the new server.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example: Information tied to a specific context</div><div class="admonitionContent_BuS1"><p>In a chat application, there might exist a group chat with a lot of people in it. Moving your
messages from this group chat to another server might be impossible, depending on the architecture
of the chat application. Typically, the messages in a group chat are stored on the server
hosting the group. Moving the messages of one individual from one server to another is not
possible in these cases.</p></div></div>
<a name="example-static-information" id="example-static-information"></a>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example: Information not necessarily tied to a specific context</div><div class="admonitionContent_BuS1"><p>Continuing the chat application example, it might very well be possible to move messages
written in a private chat between two actors from one server to another. An exemplary
architecture where this is possible is where all private messages are stored on the server of
the actor who sent the message. Here, an actor can move their messages to another server without
any issues.</p></div></div>
<p>Migrating an actor always involves reassigning the ownership of all actor-associated data in the
distributed network to the new actor. Should the old actor want to additionally move all data from
the old home server to another home server, more steps are needed. Account migration is not considered
a sensitive action.</p>
<p>This chapter defines behaviors and security mechanisms associated with migrating an actor identity
or messages.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="71-identity-migration">7.1 Identity migration<a href="#71-identity-migration" class="hash-link" aria-label="Direct link to 7.1 Identity migration" title="Direct link to 7.1 Identity migration">​</a></h3>
<p>Transferring message ownership from an old to a new account, known as
identity migration, necessitates coordination between the two involved accounts.</p>
<p>Identity migration is a process that can be broken down into the following steps:</p>
<ul>
<li><a href="#711-redirects">Setting up a redirect</a> to associate the new actor with the old actor.</li>
<li><a href="#72-re-signing-messages">Re-signing data</a> to grant ownership of messages sent by the old actor to
the new actor.</li>
</ul>
<p>It is not required that the new account is located on another home server as the old account.
Re-signing data and setting up a redirect are both not mandatory steps. It is up to actors to decide
to which extent they wish to perform the migration.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="711-redirects">7.1.1 Redirects<a href="#711-redirects" class="hash-link" aria-label="Direct link to 7.1.1 Redirects" title="Direct link to 7.1.1 Redirects">​</a></h4>
<p>Setting up a redirect is an optional step in the identity migration process, helping
make the transition from the old account to the new account smoother.</p>
<p>A redirect has to be confirmed by both the redirection source and the redirection target. The redirect
is only valid for one specific redirection target. Redirection targets must be valid actors, and their
home servers must be reachable when the redirect is being set up.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>&quot;Optional&quot; does not mean that home servers can choose to not implement this feature. Instead,
it means that actors can choose to not use this feature.</p></div></div>
<!-- -->
<p><em>Fig. 5: Sequence diagram depicting the setting up of a redirect.</em></p>
<p>Until a redirection source actor deletes their account, the home server of that actor should respond
with <code>307 Temporary Redirect</code> to requests for information about the redirection source. After
the redirection source deletes their account, Server A can select to either respond with
<code>308 Permanent Redirect</code>, or to remove the redirect entirely.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="72-re-signing-messages">7.2 Re-signing messages<a href="#72-re-signing-messages" class="hash-link" aria-label="Direct link to 7.2 Re-signing messages" title="Direct link to 7.2 Re-signing messages">​</a></h3>
<p>Re-signing messages is the process of transparently changing the signature of messages while leaving
the content of the messages unchanged. &quot;Transparently&quot; refers to the fact that an outsider can
verify the following facts:</p>
<ul>
<li>Both involved actors have agreed to the re-signing of the messages.</li>
<li>The &quot;old&quot; actor has proven ownership of the signature keys used to produce the &quot;old&quot; signatures
of the messages.</li>
<li>The message content has not changed during the re-signing process.</li>
</ul>
<p>The intended use cases for re-signing messages are:</p>
<ul>
<li>Changing ownership of messages from one actor to another. This enables seamless transitions
between accounts while preserving the integrity of the messages.</li>
<li>Reducing the amount of keys that need to be remembered by an actor is done if the actor deems it to
be convenient.</li>
<li>&quot;Rotate keys of past messages&quot; - This is useful when an actor&#x27;s private identity key has been
compromised, and the actor wants to ensure that all messages sent by them are still owned by them
and not at risk of being tampered with.</li>
</ul>
<p>Actors must not be able to re-sign messages to which they cannot prove signature-key ownership.</p>
<p>Additionally, servers must verify the following things about re-signed messages:</p>
<ul>
<li>The new signature matches the messages&#x27; contents and is valid.</li>
<li>The ID-Cert corresponding to the new signature is a valid ID-Cert, issued by the correct home
server.</li>
<li>The ID-Cert corresponding to the new signature has a public key that was specified in the
<code>allowedResigningKeys</code> property sent to the server when message re-signing was requested.</li>
<li>The <code>expires</code> UNIX timestamp, specified when the server replied to the re-signing request,
has not been reached or passed when the re-signed message was received by the server.</li>
</ul>
<p>Below is a sequence diagram depicting a typical re-signing process, which transfers ownership of
messages from Alice A to Alice B.</p>
<!-- -->
<p>To allow for a singular set of behaviors, which fit the three intended use cases mentioned prior,
not all messages stored by the server of an actor need to be re-signed.
Besides querying for all non-re-signed messages, actors can also query for all non-resigned
message whose signatures correspond to a specific ID-Cert. The API routes
for re-signing messages are documented in the <a href="https://apidocs.polyproto.org" target="_blank" rel="noopener noreferrer">API documentation</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="721-message-batches">7.2.1 Message batches<a href="#721-message-batches" class="hash-link" aria-label="Direct link to 7.2.1 Message batches" title="Direct link to 7.2.1 Message batches">​</a></h4>
<p>Messages that have not yet been re-signed are being delivered to an actor in batches. A batch is
a JSON object, representing messages sent using the same ID-Cert. An
exemplary array of message batches, as returned by the server, might look as follows:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id_cert</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;QLASDiohs79034sjkldfny8eppqxncp7n4g9vozeyuiwofxb...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    messages</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        signature</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ASDiohs79034sjkldfny8eppqxncp7n4g9vozeyuiwofxb...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        content</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Hello!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        signature</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ASDiohs7902347sjkldfny8eafhjhjafdlk4g121ghjkz...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        content</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          message</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Hello again!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id_cert</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;QLAxasdiohs79034sjkldfny8eppqxncp7n4g9vozeyuiwofxn...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    messages</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>The concrete values held by a message batch are up to the concrete implementation. The prior JSON
array depicting an array of message batches is only an example. However, it is mandatory that a
message batch holds the following information:</p>
<ul>
<li>The ID-Cert used to sign the messages in the batch</li>
<li>An array of messages, which must at least contain the following information:<!-- -->
<ul>
<li>The signature of the message</li>
<li>The full content of the message</li>
</ul>
</li>
</ul>
<p>Returning re-signed messages to the server is done in the same format as the server sends them to
the client.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="722-server-imposed-limits">7.2.2 Server-imposed limits<a href="#722-server-imposed-limits" class="hash-link" aria-label="Direct link to 7.2.2 Server-imposed limits" title="Direct link to 7.2.2 Server-imposed limits">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="7221-body-size">7.2.2.1 Body size<a href="#7221-body-size" class="hash-link" aria-label="Direct link to 7.2.2.1 Body size" title="Direct link to 7.2.2.1 Body size">​</a></h5>
<p>Servers can limit the size of an HTTP request body containing re-signed messages.
If a body size limit is imposed, the server must communicate
this to clients in their response to a query for messages that have not yet been re-signed.
Communicating the body size limit is done by adding an <code>X-P2-Return-Body-Size-Limit</code> header to the
response. If this header is not present or has a value of <code>0</code>, clients should assume that there is
no body size limit.</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="7222-interval-between-re-signing-batches">7.2.2.2 Interval between re-signing batches<a href="#7222-interval-between-re-signing-batches" class="hash-link" aria-label="Direct link to 7.2.2.2 Interval between re-signing batches" title="Direct link to 7.2.2.2 Interval between re-signing batches">​</a></h5>
<p>Servers must define an interval, which a client must wait for before sending a new batch of re-signed
messages to the server.</p>
<p>The server communicates this interval to the client as a response to receiving a batch of re-signed
messages from the client. The interval is communicated by adding a
<code>Retry-After</code> header to the response. The value of this header is a 16-bit integer. The integer
represents a delay in seconds that a client must wait for before sending the next batch of re-signed
messages.</p>
<p>Clients should expect that the duration of the interval changes between batches. The server can
dynamically adjust the duration that a client must wait before being allowed to send the next
batch of re-signed messages. The server can also select to not impose an interval between re-signing
batches. Clients should also expect that the server suddenly decides to impose an interval between
re-signing batches, even if it has not done so before.</p>
<p>If this header has a value of <code>0</code>, clients should assume that there is no interval
between re-signing batches.</p>
<p><em>Fig. 7: Sequence diagram depicting the re-signing procedure.</em></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="73-moving-data">7.3 Moving data<a href="#73-moving-data" class="hash-link" aria-label="Direct link to 7.3 Moving data" title="Direct link to 7.3 Moving data">​</a></h3>
<p>In cases of an imminent server shutdown or distrust in the old server, moving data from the old server
is necessary to prevent data loss.</p>
<p>Note that only <a href="#example-static-information">&quot;static&quot; resources</a> can be moved. &quot;Dynamic&quot; resources,
which are resources tied to a specific context, can be migrated through <a href="#72-re-signing-messages">re-signing messages</a>.</p>
<p>This process extends upon the reassigning ownership process and
usually involves the following steps:</p>
<ol>
<li>Using the old account, the client requests a data export from their old home server.</li>
<li>The old home server sends a data export to the client. The client will check the signatures on
the exported data to ensure it was not tampered with.</li>
<li>The new account re-signs the data with its own keys and imports it into the new home server.</li>
<li>The new home server verifies the data and signals that the import was successful.</li>
<li>The old client requests the deactivation or deletion of the old account on the old home server.</li>
</ol>
<!-- -->
<p><em>Fig. 8: Sequence diagram depicting the data-moving process.</em></p>
<p>The API routes for data export and import are documented in the
<a href="https://apidocs.polyproto.org" target="_blank" rel="noopener noreferrer">API documentation</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="731-resource-addressing-with-relative-roots">7.3.1 Resource Addressing with Relative Roots<a href="#731-resource-addressing-with-relative-roots" class="hash-link" aria-label="Direct link to 7.3.1 Resource Addressing with Relative Roots" title="Direct link to 7.3.1 Resource Addressing with Relative Roots">​</a></h4>
<p>Moving data from one server to another might break references to this data. To prevent this as much
as possible, resource addressing with relative roots is recommended for data behind an additional
layer of indirection.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example</div><div class="admonitionContent_BuS1"><p>In a chat service, a user might have posted a message containing a picture. In this example, the
picture is stored on the user&#x27;s home server, which is not necessarily the same server as the
chat service. If the user moves their account to another server, the picture might not be
accessible anymore.</p></div></div>
<p>Resource addressing with relative roots aids in preventing this issue. Instead of referring to
the absolute URL of the resource, the server processing the resource generates a unique identifier.
This identifier can be used to retrieve the resource from the server. Most importantly, this
identifier does not change when the resource is moved to another server. If the base domain of the
new server is known, the identifier can be used to retrieve the resource from the new server.
The &quot;relative root&quot; is the base domain of the server, which is used to retrieve the resource.</p>
<p>The uniqueness constraint of the identifier is important. If a collision occurs when trying to
move the resource to another server, the resource cannot be migrated in a way that preserves the
references to it. One way to ensure the uniqueness of the identifier is to use a hash function on the
resource itself. Combining this hash with a cryptographically strong nonce, then hashing the result of
concatenating the nonce and the hash of the resource should yield a unique identifier.</p>
<p>The URI for resource addressing with relative roots is formatted as follows:</p>
<p><code>&lt;server_url&gt;/.p2/core/resource/&lt;resource_id&gt;</code></p>
<p>Uploaded resources can be made private, and access to them can be controlled via allow- and deny lists,
specifying access properties for each individual resource. Individual actors and entire instances can
be part of these allow- and deny lists. Marking a resource as private restricts access to only the
uploader and the actors and instances that are part of the allow list. APIs and JSON schemas
associated with access control are part of the <a href="https://apidocs.polyproto.org" target="_blank" rel="noopener noreferrer">API documentation</a>.</p>
<p>The API routes for resource addressing with relative roots are documented more thoroughly in the
<a href="https://apidocs.polyproto.org" target="_blank" rel="noopener noreferrer">API documentation</a>.</p>
<p>Servers with no need for resource addressing with relative roots can select to not implement this
feature. Servers not implementing this feature should return a <code>404 Not Found</code> status code when
the API route is accessed. Clients should expect finding servers not implementing this feature.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="732-polyproto-exportimport-format">7.3.2 polyproto export/import format<a href="#732-polyproto-exportimport-format" class="hash-link" aria-label="Direct link to 7.3.2 polyproto export/import format" title="Direct link to 7.3.2 polyproto export/import format">​</a></h4>
<p>Data exports and -imports must use the polyproto export/import format. Home servers are required to
support this format when actors perform data exports and imports.</p>
<p>The data is a <a href="https://en.wikipedia.org/wiki/Gzip" target="_blank" rel="noopener noreferrer">gzipped</a> <a href="https://en.wikipedia.org/wiki/Tar_(computing)" target="_blank" rel="noopener noreferrer">tarball</a>
archive (.tar.gz) named <code>export1234567890-user@subdomain.example.com</code>, where</p>
<ul>
<li><code>export[numbers]</code> is the word <code>export</code> with 20 random digits appended to it</li>
<li><code>user</code> is the actor&#x27;s name</li>
<li><code>subdomain.example.com</code> is the domain name of the server the actor is registered on.</li>
</ul>
<p>This file archive contains a file <code>messages.p2mb</code>, which is a JSON file containing <a href="#721-message-batches">message batches</a>
of all messages sent by the user. If the server where the data export was requested from has
<a href="#731-resource-addressing-with-relative-roots">RawR</a> enabled, the file archive will contain a
folder named <code>rawr</code>. This folder contains all RawR content uploaded by the actor to that server.
The files in this folder are named after the resource ID given to the resource.
File extensions are only added if they were known to the server.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example</div><div class="admonitionContent_BuS1"><p>An example file name might be
<code>2c851bfb6daffa944fa1723c7bd4d362ffbc9defe292f2daaf05e895989d179b.jxl</code>, referencing the file
which was hosted at <code>&lt;server_url&gt;/.p2/core/resource/2c851bfb6daffa944fa1723c7bd4d362ffbc9defe292f2daaf05e895989d179b.jxl</code>.</p></div></div>
<p>In addition, the folder <code>rawr</code> contains a file named <code>access_properties.p2al</code>. This JSON
file contains a data structure mapping each resource ID to an access properties object. In particular,
the file is structured as an array containing objects. Each object has a key that is equal
to the resource ID of a resource in the <code>rawr</code> directory and a value that is an object
representing the access properties. An example of the contents of this file is given below:</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example of an <code>access_properties.p2al</code> file</div><div class="admonitionContent_BuS1"><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;2062a23e2a25b226ca4c546fec5ec06e0df9648281f45da8b5aaabebdf66cf4c.jxl&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;private&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;allowlist&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;user1@example.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;instance.example.com&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;denylist&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;user2@example.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;otherinstance@example.com&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;a9144379a161e1fcf6b07801b70db6d6c481933bd634fe2409eb713723ab1a0a&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;private&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;allowlist&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;user1@example.com&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;denylist&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div></div></div>
<p>If the server where the data export was requested from is the actor&#x27;s home server, the
archive will contain a folder <code>certs</code> and a file <code>crypt_certs.p2epk</code>.</p>
<p>The folder <code>certs</code> contains all ID-Certs the server has stored of the actor. The ID-Certs are stored
in <a href="https://web.archive.org/web/20250107131731/https://learn.microsoft.com/en-us/azure/iot-hub/reference-x509-certificates#:~:text=ASN.1%20encoding.-,ascii%20pem%20format,-A%20PEM%20certificate" target="_blank" rel="noopener noreferrer">ASCII PEM format</a>.</p>
<p>The file <code>crypt_certs.p2epk</code> contains all <a href="#63-private-key-loss-prevention-and-private-key-recovery">encrypted private key material</a>
that the actor has uploaded to the server. Just like <code>messages.p2mb</code>, <code>crypt_certs.p2epk</code> is a standard
JSON file.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="74-challenges-and-trust">7.4 Challenges and trust<a href="#74-challenges-and-trust" class="hash-link" aria-label="Direct link to 7.4 Challenges and trust" title="Direct link to 7.4 Challenges and trust">​</a></h3>
<p>Changing the publicly visible ownership of actor data requires the chain of trust to be maintained.
If an &quot;old&quot; account wants to change the publicly visible ownership of its data, the &quot;old&quot;
account must prove that it possesses the private keys that were used to
sign the messages. This is done by signing a <a href="#42-challenge-strings">challenge string</a> with the private
keys. If the server verifies the challenge, it authorizes the new account to re-sign the old
account&#x27;s messages signed with the verified key. Instead of overwriting the message, a new message variant
with the new signature is created, preserving the old message.</p>
<p>Implementations and protocol extensions should carefully consider the extent of messages that can be
re-signed.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example</div><div class="admonitionContent_BuS1"><p>In the case of a social media platform with quote-posting functionality, it is reasonable to
assume that re-signing a quoted post is allowed. However, this would likely change the
signature of the quoted post, which would be undesirable. Edge cases like these are up to
implementations to handle and should be well documented.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-protocol-extensions-p2-extensions">8. Protocol extensions (P2 extensions)<a href="#8-protocol-extensions-p2-extensions" class="hash-link" aria-label="Direct link to 8. Protocol extensions (P2 extensions)" title="Direct link to 8. Protocol extensions (P2 extensions)">​</a></h2>
<p>polyproto leaves room for extensions, outsourcing concepts such as concrete
message types to protocol extensions. This allows for a more flexible
core protocol, which can be adapted to a wide variety of use cases. The following sections
define:</p>
<ul>
<li>protocol extensions, also called P2 extensions</li>
<li>how protocol extensions interact with the core protocol</li>
<li>requirements, which must be fulfilled by protocol extensions to become officially endorsed</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="81-extension-design">8.1 Extension design<a href="#81-extension-design" class="hash-link" aria-label="Direct link to 8.1 Extension design" title="Direct link to 8.1 Extension design">​</a></h3>
<p>P2 extensions <em>should</em> be either of the following:</p>
<ul>
<li>a <strong>major</strong> technological addition, which can be taken advantage of
by other extensions. Examples of this are:<!-- -->
<ul>
<li>a unified WebSocket Gateway connection scheme</li>
<li>Message Layer Encryption (MLS)</li>
<li>Compatibility with other protocols (e.g., Matrix, ActivityPub)</li>
</ul>
</li>
<li>a definition of a <a href="#9-services">service</a>. Examples of this are:<!-- -->
<ul>
<li>A federated chat application</li>
<li>A federated social media platform</li>
</ul>
</li>
</ul>
<p>A good P2 extension should never be both at the same time. If a P2 extension is both a
major technological addition and a document describing a particular application use case, it should
likely be split into two separate extensions.</p>
<p>Designing P2 extensions, which only specify a single route or a small set of behavior changes, is
discouraged. Instead, these should be implemented as part of a larger extension, which offers a
more comprehensive set of features.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>If you are, say, developing a polyproto server implementation with a feature that is not part of
the default polyproto specification, you do not have to create a P2 extension for this feature.
P2 extensions are useful for defining interoperable services, which can be implemented by a variety
of servers and clients.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="82-namespaces">8.2 Namespaces<a href="#82-namespaces" class="hash-link" aria-label="Direct link to 8.2 Namespaces" title="Direct link to 8.2 Namespaces">​</a></h3>
<p>A namespace is a string used to identify a specific P2 extension. Used as a prefix in URLs, they
prevent route name collisions between different extensions. Namespaces should be unique
and descriptive. They must only contain lowercase letters, numbers, hyphens, and underscores.
Namespaces must be at least 2 characters long and at most 64 characters long.</p>
<p>Officially endorsed P2 extensions have priority over selecting namespaces. If a namespace is already
taken by an officially endorsed extension, a different namespace must be chosen. If a namespace
collision exists between an officially endorsed extension and a regular P2 extension, the officially
endorsed extension has priority.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="83-officially-endorsed-extensions">8.3 Officially endorsed extensions<a href="#83-officially-endorsed-extensions" class="hash-link" aria-label="Direct link to 8.3 Officially endorsed extensions" title="Direct link to 8.3 Officially endorsed extensions">​</a></h3>
<p>Officially endorsed extensions are extensions that either:</p>
<ul>
<li>have undergone review and approval by the polyproto maintainers</li>
<li>have been developed by the maintainers themselves</li>
<li>have been developed by a third party and are now maintained by the polyproto maintainers</li>
</ul>
<p>Contact the polyphony-chat maintainers at <a href="mailto:info@polyphony.chat" target="_blank" rel="noopener noreferrer">info@polyphony.chat</a>
if you want to have your extension officially endorsed.</p>
<p>Officially endorsed extensions must fulfill all the requirements listed in
<a href="#8-protocol-extensions-p2-extensions">section 8</a>.</p>
<p>Each version of an extension developed by outside parties must undergo the review process before
being officially endorsed.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="84-versioning-and-yanking">8.4 Versioning and yanking<a href="#84-versioning-and-yanking" class="hash-link" aria-label="Direct link to 8.4 Versioning and yanking" title="Direct link to 8.4 Versioning and yanking">​</a></h3>
<p>Semantic Versioning v2.0.0 is used for versioning P2 extensions. The version number of an extension
is defined in the extension&#x27;s documentation. The version number must be updated whenever a change is
made to the extension. The only exception to this rule is when marking an extension as deprecated
(yanking).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="841-yanking">8.4.1 Yanking<a href="#841-yanking" class="hash-link" aria-label="Direct link to 8.4.1 Yanking" title="Direct link to 8.4.1 Yanking">​</a></h4>
<p>Yanking an extension means that the extension is no longer supported and that it <strong>should not</strong> be used.
A later version of the extension should be used instead. Yanked extension versions should prominently
display the &quot;yanked&quot; status next to the version number in the extension&#x27;s documentation.</p>
<p>Versions of officially endorsed P2 extensions can normally not be removed, only marked as yanked.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="85-dependencies">8.5 Dependencies<a href="#85-dependencies" class="hash-link" aria-label="Direct link to 8.5 Dependencies" title="Direct link to 8.5 Dependencies">​</a></h3>
<p>P2 extensions can depend on other P2 extensions. If an extension depends on another extension, the
name of the dependency must be listed in the extension&#x27;s documentation, along with a link to the
dependency&#x27;s specification document.</p>
<p>The following syntax is used for indicating the version number of a dependency:</p>
<table><thead><tr><th>Syntax</th><th>Meaning</th></tr></thead><tbody><tr><td><code>1.0.0</code></td><td>Any version of the dependency with the major version <code>1</code>, a minor version of <code>0</code>, and a patch version of <code>0</code> or greater is required.</td></tr><tr><td><code>1.0</code></td><td>Any version of the dependency with the major version <code>1</code> and the minor version <code>0</code> is required. The patch version is unimportant.</td></tr><tr><td><code>1</code></td><td>Any version of the dependency with the major version <code>1</code> is required. The minor and patch versions are unimportant.</td></tr></tbody></table>
<p>When selecting a version number for a dependency, the highest possible version number that fulfills
the requirements should be selected.</p>
<p>The name of the dependency, along with the version number, is to be listed right beneath the extension&#x27;s
version declaration in the extension&#x27;s documentation. Ideally, a link to the dependencies&#x27; specification
document should be included.</p>
<p>To grow the ecosystem of interoperable <a href="#9-services">services</a>, it is encouraged to first develop
a generic version of that service, which acts as a shared base for all implementations. This shared
base can then be extended with the exact, non-service-critical features that are needed for a
specific implementation.</p>
<p>For example, a generic, federated chat service extension might offer routes for adding
reactions to chat messages. However, a route for adding reactions with full-screen animation effects
would be better suited as an implementation-specific detail.</p>
<p>If possible for the given use case, P2 extensions should depend on and extend already existing,
officially endorsed P2 extensions.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example</div><div class="admonitionContent_BuS1"><p>Say, you are developing a social chat platform using polyproto. In this example, you would like
your chat platform to have a feature, which is not part of the officially endorsed
<code>polyproto-chat</code> extension. Instead of developing a new extension from scratch, your chat
extension should likely depend on <code>polyproto-chat</code> and define only this new feature as part of
your own extension.</p></div></div>
<p>Doing this ensures a high level of interoperability across all different implementations of a specific
application group.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="86-routes">8.6 Routes<a href="#86-routes" class="hash-link" aria-label="Direct link to 8.6 Routes" title="Direct link to 8.6 Routes">​</a></h3>
<p>Polyproto extensions must never change, add, or remove routes defined by the extension they depend on.
Instead, routes with alternating or new behavior must be added under a newly defined namespace, which
must differ from the original namespace. Changing the behavior of existing routes breaks compatibility
with other implementations of the same extension.</p>
<p>Route paths must always start with <code>.p2/</code>, followed by the extensions&#x27; namespace. Namespaces are
explained in <a href="#82-namespaces">section 8.2</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="9-services">9. Services<a href="#9-services" class="hash-link" aria-label="Direct link to 9. Services" title="Direct link to 9. Services">​</a></h2>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>A &quot;service&quot; is any application-specific implementation of polyproto, defined by a P2 extension.
All services are P2 extensions, but not all P2 extensions are services.</p></div></div>
<p>Actors can use their identity to register with any server hosting polyproto services, such as polyproto-chat.
These servers can be the actors&#x27; home server, but can also be foreign servers. There is no limitation
to how many services any given actor can register with and what these services are.</p>
<p>Application-specific implementations of polyproto should consider that users of their service might
also want to register for services offered by other servers, using the same identity.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="91-discoverability">9.1 Discoverability<a href="#91-discoverability" class="hash-link" aria-label="Direct link to 9.1 Discoverability" title="Direct link to 9.1 Discoverability">​</a></h2>
<p>The discoverability feature allows users who are registered with the same service but on different
servers to communicate with each other. The actor initiating the communication only needs to know the
federation ID of the actor they want to communicate with. Consider the following example:</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example: Discovering services</div><div class="admonitionContent_BuS1"><div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The example below is simplified for the sake of clarity. In a real-world scenario, Alice
and the chat server would perform the foreign server authentication procedure described in
<a href="#411-authenticating-on-a-foreign-server">section 4.1.1</a> before Alice can send a
chat message to Bob. The example also uses a simplified example of how polyproto-chat works.</p></div></div><p>Alice and Bob want to communicate with each other. Both Alice and Bob are registered on servers
that host the polyproto-chat service. However, Alice and Bob are not registered on the same
server, and they do not share any chat rooms. Alice types in Bob&#x27;s federation ID into her
chat client. The client then queries Bob&#x27;s home server to find out which server Bob uses
for the polyproto-chat service. Alice&#x27;s client can then send the chat message to Bob&#x27;s server,
which will forward the chat message to Bob.</p><p><em>Fig. 9: Sequence diagram depicting how Alice&#x27;s client discovers which server Bob is using for
the exemplary polyproto-chat service.</em></p><p>The example demonstrates how Alice can communicate with Bob, even though they do not share any
servers.</p></div></div>
<p>To be discoverable, an actor must add a key-value pair to their home server&#x27;s database. The
key is the name of the service, and the value is the base URL of the server hosting the service.</p>
<p>The API routes for managing discoverability are documented in the
<a href="https://apidocs.polyproto.org" target="_blank" rel="noopener noreferrer">API documentation</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="911-changing-a-primary-service-provider">9.1.1 Changing a primary service provider<a href="#911-changing-a-primary-service-provider" class="hash-link" aria-label="Direct link to 9.1.1 Changing a primary service provider" title="Direct link to 9.1.1 Changing a primary service provider">​</a></h3>
<p>Keys are unique in the actor-scoped service-&gt;service-provider table. Actors wanting
to register for two or more different implementations of the same service must select which
service provider to use as a &quot;primary service provider&quot; for that service.</p>
<p>If the actor is human, clients must not override the existing
key-value pair silently. Instead, clients must either ask the actor to confirm the change or
not change the key-value pair. Automated actors may override values as they see fit.</p>
<p>Changing a primary service provider entry is considered a sensitive action and should
require a second factor of authentication.</p>
<p>Messages do not get moved or re-signed when changing the primary
service provider for a given service. If an actor wants to move their messages to the new primary
service provider, they must request a <a href="#7-migrations">migration</a>.</p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/protocol-definitions"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Protocol Definitions</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/protocols/auth"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">polyproto-auth Extension Specification</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-terminology-used-in-this-document" class="table-of-contents__link toc-highlight">1. Terminology used in this document</a></li><li><a href="#2-trust-model" class="table-of-contents__link toc-highlight">2. Trust model</a></li><li><a href="#3-apis-and-underlying-communication-protocols" class="table-of-contents__link toc-highlight">3. APIs and underlying communication protocols</a><ul><li><a href="#31-well-known" class="table-of-contents__link toc-highlight">3.1 <code>.well-known</code></a></li><li><a href="#32-websocket-protocol" class="table-of-contents__link toc-highlight">3.2 WebSocket Protocol</a></li><li><a href="#34-http" class="table-of-contents__link toc-highlight">3.4 HTTP</a></li><li><a href="#35-internet-protocol-ip" class="table-of-contents__link toc-highlight">3.5 Internet Protocol (IP)</a></li><li><a href="#36-compression" class="table-of-contents__link toc-highlight">3.6 Compression</a></li></ul></li><li><a href="#4-federated-identity" class="table-of-contents__link toc-highlight">4. Federated identity</a><ul><li><a href="#41-authentication" class="table-of-contents__link toc-highlight">4.1 Authentication</a></li><li><a href="#42-challenge-strings" class="table-of-contents__link toc-highlight">4.2 Challenge strings</a></li><li><a href="#43-protection-against-misuse-by-malicious-home-servers" class="table-of-contents__link toc-highlight">4.3 Protection against misuse by malicious home servers</a></li></ul></li><li><a href="#5-federation-ids-fids" class="table-of-contents__link toc-highlight">5. Federation IDs (FIDs)</a></li><li><a href="#6-cryptography-and-id-certs" class="table-of-contents__link toc-highlight">6. Cryptography and ID-Certs</a><ul><li><a href="#61-home-server-signed-certificates-for-public-client-identity-keys-id-cert" class="table-of-contents__link toc-highlight">6.1 Home server signed certificates for public client identity keys (ID-Cert)</a></li><li><a href="#62-actor-identity-keys-and-message-signing" class="table-of-contents__link toc-highlight">6.2 Actor identity keys and message signing</a></li><li><a href="#63-private-key-loss-prevention-and-private-key-recovery" class="table-of-contents__link toc-highlight">6.3 Private key loss prevention and private key recovery</a></li><li><a href="#64-caching-of-id-certs" class="table-of-contents__link toc-highlight">6.4 Caching of ID-Certs</a></li><li><a href="#65-cryptographic-specifications" class="table-of-contents__link toc-highlight">6.5 Cryptographic specifications</a></li><li><a href="#66-best-practices" class="table-of-contents__link toc-highlight">6.6 Best practices</a></li></ul></li><li><a href="#7-migrations" class="table-of-contents__link toc-highlight">7. Migrations</a><ul><li><a href="#71-identity-migration" class="table-of-contents__link toc-highlight">7.1 Identity migration</a></li><li><a href="#72-re-signing-messages" class="table-of-contents__link toc-highlight">7.2 Re-signing messages</a></li><li><a href="#73-moving-data" class="table-of-contents__link toc-highlight">7.3 Moving data</a></li><li><a href="#74-challenges-and-trust" class="table-of-contents__link toc-highlight">7.4 Challenges and trust</a></li></ul></li><li><a href="#8-protocol-extensions-p2-extensions" class="table-of-contents__link toc-highlight">8. Protocol extensions (P2 extensions)</a><ul><li><a href="#81-extension-design" class="table-of-contents__link toc-highlight">8.1 Extension design</a></li><li><a href="#82-namespaces" class="table-of-contents__link toc-highlight">8.2 Namespaces</a></li><li><a href="#83-officially-endorsed-extensions" class="table-of-contents__link toc-highlight">8.3 Officially endorsed extensions</a></li><li><a href="#84-versioning-and-yanking" class="table-of-contents__link toc-highlight">8.4 Versioning and yanking</a></li><li><a href="#85-dependencies" class="table-of-contents__link toc-highlight">8.5 Dependencies</a></li><li><a href="#86-routes" class="table-of-contents__link toc-highlight">8.6 Routes</a></li></ul></li><li><a href="#9-services" class="table-of-contents__link toc-highlight">9. Services</a></li><li><a href="#91-discoverability" class="table-of-contents__link toc-highlight">9.1 Discoverability</a><ul><li><a href="#911-changing-a-primary-service-provider" class="table-of-contents__link toc-highlight">9.1.1 Changing a primary service provider</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer p-0"><div class="container container-fluid py-8"><div class="row footer__links"><div class="col footer__col last:mb-0"><div class="footer__title text-lg font-body text-poly-indigo-2">GET HELP!</div><ul class="footer__items clean-list font-body"><li class="footer__item"><a class="footer__link-item text-black hover:text-poly-indigo-1 inline-flex items-center" href="/docs/intro">Documentation</a></li><li class="footer__item"><a href="https://github.com/polyphony-chat/polyproto-rs/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item text-black hover:text-poly-indigo-1 inline-flex items-center">See a bug? File an issue!</a></li></ul></div><div class="col footer__col last:mb-0"><div class="footer__title text-lg font-body text-poly-indigo-2">SOCIAL</div><ul class="footer__items clean-list font-body"><li class="footer__item"><a href="https://github.com/polyphony-chat/polyproto-rs" target="_blank" rel="noopener noreferrer" class="footer__link-item text-black hover:text-poly-indigo-1 inline-flex items-center">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discord.com/invite/m3FpcapGDD" target="_blank" rel="noopener noreferrer" class="footer__link-item text-black hover:text-poly-indigo-1 inline-flex items-center">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div></div><div class="bg-poly-green-1 w-full h-20 flex items-center justify-center"><span class="text-sm">Copyright © 2025 The polyproto Contributors.</span></div></footer></div>
</body>
</html>